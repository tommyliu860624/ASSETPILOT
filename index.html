<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AssetPilot</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"AssetPilot 2026","short_name":"AssetPilot","start_url":".","display":"standalone","orientation":"portrait","background_color":"#0f172a","theme_color":"#0f172a","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/10384/10384161.png","sizes":"512x512","type":"image/png"}]}' />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AssetPilot">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .text-gradient { background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-image: linear-gradient(to right, #60a5fa, #a855f7); }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; }
        .calc-btn { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 1.25rem; font-weight: 500; background-color: rgba(51, 65, 85, 0.5); transition: all 0.1s; }
        .calc-btn:active { background-color: rgba(71, 85, 105, 0.8); transform: scale(0.95); }
        .calc-btn.op { background-color: #f59e0b; color: white; }
        .calc-btn.eq { background-color: #3b82f6; color: white; }
        input[type="date"] { color-scheme: dark; appearance: none; -webkit-appearance: none; background-color: transparent; min-height: 2.5rem; }
        .blur-content { filter: blur(8px); transition: filter 0.3s ease; }
        .no-blur { filter: blur(0); transition: filter 0.3s ease; }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useLayoutEffect, useCallback } = React;

        // --- é è¨­è³‡æ–™ ---
        const INITIAL_CASH = [];
        const INITIAL_TW_STOCKS = [];
        const INITIAL_FOREIGN_STOCKS = []; 
        const INITIAL_FOREIGN_CASH = []; 
        const INITIAL_GOALS = [];
        const INITIAL_SOP = [];
        const INITIAL_SOP_DETAILS = [
            { title: "ç¯„ä¾‹ï¼šæ¯æœˆ 1 è™Ÿ", steps: ["æª¢æŸ¥è–ªæ°´å…¥å¸³", "åˆ†é…ç”Ÿæ´»è²»"] },
            { title: "ç¯„ä¾‹ï¼šæ¯æœˆ 5 è™Ÿ", steps: ["ç¢ºèªå®šæœŸå®šé¡æ‰£æ¬¾"] }
        ];
        // Default Rates (Expanded)
        const INITIAL_RATES = { 
            USD: 32.50, JPY: 0.22, CNY: 4.50, EUR: 35.00, GBP: 41.00, AUD: 21.50,
            CAD: 23.00, HKD: 4.10, SGD: 24.00, KRW: 0.024, CHF: 36.00, 
            NZD: 19.50, THB: 0.90, VND: 0.0013, MYR: 7.00
        };

        // æ“´å……å¹£åˆ¥æ¸…å–®
        const CURRENCY_OPTIONS = [
            { code: 'USD', name: 'ç¾å…ƒ' },
            { code: 'JPY', name: 'æ—¥åœ“' },
            { code: 'EUR', name: 'æ­å…ƒ' },
            { code: 'CNY', name: 'äººæ°‘å¹£' },
            { code: 'GBP', name: 'è‹±éŠ' },
            { code: 'AUD', name: 'æ¾³å¹£' },
            { code: 'CAD', name: 'åŠ å¹£' },
            { code: 'HKD', name: 'æ¸¯å¹£' },
            { code: 'SGD', name: 'æ–°åŠ å¡å¹£' },
            { code: 'KRW', name: 'éŸ“å…ƒ' },
            { code: 'CHF', name: 'ç‘å£«æ³•éƒ' },
            { code: 'NZD', name: 'ç´è¥¿è˜­å¹£' },
            { code: 'THB', name: 'æ³°éŠ–' },
            { code: 'VND', name: 'è¶Šå—ç›¾' },
            { code: 'MYR', name: 'é¦¬ä¾†è¥¿äºæ—å‰ç‰¹' }
        ];

        // --- Helper Functions ---
        const formatMoney = (amount) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', currencyDisplay: 'code', maximumFractionDigits: 0 }).format(amount).replace('TWD', 'NTD');
        const formatForeign = (amount, currency) => new Intl.NumberFormat('en-US', { style: 'currency', currency: currency || 'USD', currencyDisplay: 'code' }).format(amount);
        
        const getLocalDateString = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- æ­·å²è³‡æ–™ç”Ÿæˆå™¨ (ç©º) ---
        const generateCorrectedHistory = () => [];

        // --- éŸ³æ•ˆå¼•æ“ ---
        const SoundEngine = {
            ctx: null,
            init: () => {
                if (!SoundEngine.ctx) { SoundEngine.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
                if (SoundEngine.ctx.state === 'suspended') { SoundEngine.ctx.resume(); }
            },
            play: (type) => {
                try {
                    SoundEngine.init();
                    const ctx = SoundEngine.ctx;
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    const now = ctx.currentTime;
                    switch (type) {
                        case 'tap': osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(300, now + 0.05); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05); osc.start(now); osc.stop(now + 0.05); break;
                        case 'success': osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); osc.frequency.setValueAtTime(1108.73, now + 0.1); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0.05, now + 0.1); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3); osc.start(now); osc.stop(now + 0.3); break;
                        case 'delete': osc.type = 'triangle'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now + 0.2); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2); osc.start(now); osc.stop(now + 0.2); break;
                        case 'switch': osc.type = 'square'; osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.02, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.03); osc.start(now); osc.stop(now + 0.03); break;
                        case 'pop': osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(600, now + 0.1); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                        default: break;
                    }
                } catch (e) { console.error("Audio playback error", e); }
            }
        };

        // --- Tutorial Steps ---
        const TUTORIAL_STEPS = [
            { targetId: null, title: "æ­¡è¿ä½¿ç”¨ AssetPilot", content: "å…¨æ–°å‡ç´šçš„è³‡ç”¢å°èˆªå“¡ã€‚è®“æˆ‘å€‘èŠ± 1 åˆ†é˜ï¼Œå¸¶æ‚¨å¿«é€ŸæŒæ¡è³‡ç”¢ç®¡ç†çš„ç§˜è¨£ã€‚", tab: "dashboard" },
            { targetId: "main-nav", title: "ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½", content: "é€™æ˜¯æ‚¨çš„æŒ‡æ®è‰™ã€‚éš¨æ™‚åˆ‡æ›ã€Œæˆ°æƒ…å®¤ã€ã€ã€Œé‡‘åº«ã€èˆ‡ã€Œåˆ†æã€ä¸‰å¤§é é¢ï¼Œå¾ä¸åŒç¶­åº¦æŒæ¡è²¡å‹™ç‹€æ³ã€‚", tab: "dashboard" },
            { targetId: "chart-area", title: "æˆ°æƒ…å®¤ï¼šè³‡ç”¢è¶¨å‹¢", content: "é¦–é æœ€é¡¯çœ¼çš„åœ°æ–¹é¡¯ç¤ºæ‚¨çš„è³‡ç”¢èµ°å‹¢ã€‚é»æ“Šä¸Šæ–¹çš„æŒ‰éˆ•å¯åˆ‡æ›ã€Œæ™‚é–“å€é–“ã€æˆ–ã€Œè³‡ç”¢é¡åˆ¥ã€ï¼Œæ·±å…¥åˆ†æç‰¹å®šéƒ¨ä½ã€‚", tab: "dashboard" },
            { targetId: "allocation-section", title: "æˆ°æƒ…å®¤ï¼šè³‡ç”¢é…ç½®", content: "ä¸€çœ¼çœ‹ç©¿æ‚¨çš„è³‡ç”¢åˆ†å¸ƒã€‚é€éé¡è‰²å€å¡Šï¼Œå¿«é€Ÿäº†è§£ç¾é‡‘ã€å°è‚¡ã€å¤–å¹£èˆ‡æµ·å¤–æŠ•è³‡çš„ä½”æ¯”ï¼Œç¢ºä¿æŠ•è³‡çµ„åˆå¹³è¡¡ã€‚", tab: "dashboard" },
            { targetId: "sop-section", title: "æˆ°æƒ…å®¤ï¼šæ¯æœˆä»»å‹™", content: "ç†è²¡éœ€è¦ç´€å¾‹ã€‚åœ¨é€™è£¡è¨­å®šæ¯æœˆçš„ SOPï¼ˆå¦‚ï¼šç™¼è–ªæ—¥åˆ†é…ã€ç¹³å¡è²»ï¼‰ï¼ŒæŒ‰éƒ¨å°±ç­å®Œæˆä»»å‹™ã€‚", tab: "dashboard" },
            { targetId: "nav-wallet", title: "å‰å¾€é‡‘åº«", content: "æ¥ä¸‹ä¾†æˆ‘å€‘é€²å…¥ã€Œé‡‘åº«ã€ï¼Œé€™æ˜¯æ‚¨ç®¡ç†æ‰€æœ‰å¸³æˆ¶èˆ‡è³‡ç”¢çš„æ ¸å¿ƒå€åŸŸã€‚", tab: "wallet" },
            { targetId: "wallet-add-cash", title: "é‡‘åº«ï¼šæ–°å¢è³‡ç”¢", content: "é»æ“Šå„å€å¡Šæ¨™é¡Œæ—çš„ã€Œ+ã€è™Ÿï¼Œå³å¯æ–°å¢è©²é¡åˆ¥çš„å¸³æˆ¶æˆ–è‚¡ç¥¨ã€‚ç³»çµ±æ”¯æ´å°å¹£ã€15ç¨®å¤–å¹£åŠå°ç¾è‚¡å³æ™‚å ±åƒ¹ã€‚", tab: "wallet" },
            { targetId: "wallet-reorder-btns-cashTW", title: "é‡‘åº«ï¼šè‡ªç”±æ’åº", content: "æ¯å€‹äººçš„ç¿’æ…£ä¸åŒã€‚é€éç®­é ­ï¼Œæ‚¨å¯ä»¥è‡ªç”±ä¸Šä¸‹ç§»å‹•å€å¡Šï¼Œå°‡æœ€å¸¸æŸ¥çœ‹çš„è³‡ç”¢ç§»åˆ°æœ€ä¸Šæ–¹ã€‚", tab: "wallet" },
            { targetId: "nav-analysis", title: "å‰å¾€åˆ†æ", content: "æœ€å¾Œæ˜¯ã€Œåˆ†æã€é é¢ï¼Œé€™è£¡æä¾›æœˆåº¦å ±è¡¨èˆ‡ç›®æ¨™è¿½è¹¤ã€‚", tab: "analysis" },
            { targetId: "goal-add-btn", title: "åˆ†æï¼šè¨­å®šç›®æ¨™", content: "ç¾åœ¨å¯ä»¥è¨­å®šã€Œå°ˆæ¬¾å°ˆç”¨ã€çš„ç›®æ¨™äº†ï¼æŒ‡å®šç‰¹å®šå¸³æˆ¶æˆ–è‚¡ç¥¨ï¼Œè¨­å®šæˆªæ­¢æ—¥æœŸï¼Œè®“ç†è²¡è¨ˆç•«æ›´å‹™å¯¦ã€‚", tab: "analysis" },
            { targetId: "header-refresh", title: "å³æ™‚æ›´æ–°", content: "å›åˆ°é ‚éƒ¨å·¥å…·åˆ—ã€‚é»æ“Šæ­¤æŒ‰éˆ•ï¼Œç³»çµ±æœƒç«‹å³é€£ç·šæ›´æ–°æ‰€æœ‰ã€Œå³æ™‚è‚¡åƒ¹ã€èˆ‡ã€ŒåŒ¯ç‡ã€ï¼Œè¨ˆç®—æœ€æ–°èº«åƒ¹ã€‚", tab: "dashboard" },
            { targetId: "header-privacy", title: "éš±ç§ä¿è­·", content: "åœ¨å…¬å…±å ´åˆä¸æƒ³è¢«çœ‹åˆ°é‡‘é¡ï¼Ÿé»æ“Šã€Œçœ¼ç›ã€åœ–ç¤ºï¼Œä¸€éµéš±è—æ‰€æœ‰æ•æ„Ÿæ•¸å­—ã€‚", tab: "dashboard" },
            { targetId: "header-settings", title: "è¨­å®šèˆ‡å‚™ä»½", content: "æœ€å¾Œï¼Œåˆ¥å¿˜äº†å®šæœŸå‚™ä»½è³‡æ–™ã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨æ­¤ä¿®æ”¹æš±ç¨±æˆ–é‡æ’­æ­¤æ•™å­¸ã€‚æº–å‚™å¥½é–‹å§‹äº†å—ï¼Ÿ", tab: "dashboard" }
        ];

        // --- Components ---
        const Icon = React.memo(({ name, className }) => <span style={{ display: 'contents' }} dangerouslySetInnerHTML={{ __html: `<i data-lucide="${name}" class="${className || ''}"></i>` }} />);
        
        const Toast = ({ message, show }) => (
            <div className={`fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-lg border border-slate-700 flex items-center gap-2 transition-all duration-300 z-[400] ${show ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'}`}>
                <Icon name="check-circle" className="w-4 h-4 text-emerald-400" />
                <span className="text-xs font-bold">{message}</span>
            </div>
        );

        // --- Spotlight Tutorial Component ---
        const TutorialSpotlight = ({ stepIndex, totalSteps, onNext, onPrev, onClose }) => {
            const step = TUTORIAL_STEPS[stepIndex];
            const [targetRect, setTargetRect] = useState(null);

            useLayoutEffect(() => {
                const updatePosition = () => {
                    if (step.targetId) {
                        const element = document.getElementById(step.targetId);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            const rect = element.getBoundingClientRect();
                            setTargetRect({ top: rect.top, left: rect.left, width: rect.width, height: rect.height, bottom: rect.bottom, right: rect.right });
                        } else { setTargetRect(null); }
                    } else { setTargetRect(null); }
                };
                const timer = setTimeout(updatePosition, 300);
                window.addEventListener('resize', updatePosition);
                return () => { window.removeEventListener('resize', updatePosition); clearTimeout(timer); };
            }, [stepIndex, step.targetId]);

            const isTop = targetRect && targetRect.top > window.innerHeight / 2;
            
            return (
                <div className="fixed inset-0 z-[300] overflow-hidden">
                    {targetRect ? (
                        <div className="absolute transition-all duration-500 ease-out border-4 border-blue-500 rounded-lg shadow-[0_0_15px_rgba(59,130,246,0.6)]"
                            style={{ top: targetRect.top - 4, left: targetRect.left - 4, width: targetRect.width + 8, height: targetRect.height + 8, boxShadow: '0 0 0 9999px rgba(0, 0, 0, 0.75)' }}></div>
                    ) : ( <div className="absolute inset-0 bg-black/70 backdrop-blur-sm transition-all duration-500"></div> )}
                    <div className={`absolute left-0 right-0 px-6 flex justify-center transition-all duration-500 ${targetRect ? '' : 'top-1/2 -translate-y-1/2'}`}
                        style={targetRect ? { top: isTop ? (targetRect.top - 20) : (targetRect.bottom + 20), transform: isTop ? 'translateY(-100%)' : 'none' } : {}}>
                        <div className="bg-slate-800 border border-slate-600 rounded-2xl p-6 w-full max-w-sm shadow-2xl relative flex flex-col">
                            {targetRect && (<div className={`absolute left-1/2 -translate-x-1/2 w-4 h-4 bg-slate-800 border-l border-t border-slate-600 transform rotate-45 ${isTop ? '-bottom-2 border-t-0 border-l-0 border-b border-r' : '-top-2'}`}></div>)}
                            <div className="flex justify-between items-center mb-2"><span className="text-[10px] uppercase tracking-wider text-blue-400 font-bold">æ­¥é©Ÿ {stepIndex + 1} / {totalSteps}</span><button onClick={onClose} className="text-slate-400 hover:text-white text-xs">è·³é</button></div>
                            <h3 className="text-lg font-bold text-white mb-2">{step.title}</h3><p className="text-slate-300 text-sm leading-relaxed mb-6">{step.content}</p>
                            <div className="flex justify-between items-center"><div className="flex gap-1">{Array.from({length: totalSteps}).map((_, i) => (<div key={i} className={`w-1.5 h-1.5 rounded-full transition-colors ${i === stepIndex ? 'bg-blue-500' : 'bg-slate-600'}`}></div>))}</div><div className="flex gap-2">{stepIndex > 0 && (<button onClick={onPrev} className="px-3 py-1.5 rounded-lg text-slate-300 hover:bg-slate-700 text-xs font-bold border border-slate-600">ä¸Šä¸€æ­¥</button>)}<button onClick={stepIndex === totalSteps - 1 ? onClose : onNext} className="px-4 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold flex items-center shadow-lg shadow-blue-600/20">{stepIndex === totalSteps - 1 ? 'é–‹å§‹ä½¿ç”¨' : 'ä¸‹ä¸€æ­¥'}{stepIndex !== totalSteps - 1 && <Icon name="chevron-right" className="w-3 h-3 ml-1" />}</button></div></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- NEW: Welcome Modal (First Time User) ---
        const WelcomeModal = ({ onConfirm }) => {
            const [name, setName] = useState('');
            return (
                <div className="fixed inset-0 z-[400] bg-black/80 backdrop-blur-md flex items-center justify-center p-6 animate-fade-in">
                    <div className="bg-slate-800 border border-slate-700 rounded-2xl p-8 w-full max-w-sm shadow-2xl text-center relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                        <div className="w-16 h-16 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto mb-6"><Icon name="user-circle" className="w-8 h-8 text-blue-400" /></div>
                        <h2 className="text-2xl font-bold text-white mb-2">æ­¡è¿ä½¿ç”¨ AssetPilot</h2>
                        <p className="text-slate-400 text-sm mb-8">é¦–å…ˆï¼Œè«‹å•æˆ‘å€‘è©²å¦‚ä½•ç¨±å‘¼æ‚¨ï¼Ÿ</p>
                        <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-center text-white text-lg focus:border-blue-500 outline-none mb-6 placeholder-slate-600 transition-all" placeholder="è¼¸å…¥æ‚¨çš„æš±ç¨±" autoFocus onKeyDown={(e) => { if(e.key === 'Enter' && name.trim()) onConfirm(name); }} />
                        <button onClick={() => onConfirm(name.trim() || 'User')} className="w-full py-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold text-lg shadow-lg shadow-blue-500/20 transition-all transform active:scale-95">é–‹å§‹æ—…ç¨‹</button>
                    </div>
                </div>
            );
        };

        // --- NEW: Goal Input Modal ---
        const GoalInputModal = ({ title, target, linkedAccounts, cash, foreignCash, deadline, onConfirm, onClose, playSfx }) => {
            const [newTitle, setNewTitle] = useState(title || '');
            const [newTarget, setNewTarget] = useState(target || '');
            const [newDeadline, setNewDeadline] = useState(deadline || '');
            const [selectedLinks, setSelectedLinks] = useState(linkedAccounts || []);

            const toggleLink = (id) => {
                if (selectedLinks.includes(id)) {
                    setSelectedLinks(selectedLinks.filter(lid => lid !== id));
                } else {
                    setSelectedLinks([...selectedLinks, id]);
                }
            };

            const assetGroups = [
                { name: 'å°å¹£ç¾é‡‘', items: cash },
                { name: 'å¤–å¹£ç¾é‡‘', items: foreignCash }
            ];

            const isTotalAssets = selectedLinks.length === 0;

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center z-[200] sm:p-6 animate-fade-in" onClick={onClose}>
                    <div className="bg-slate-800 border-t sm:border border-slate-700 rounded-t-2xl sm:rounded-2xl p-6 w-full max-w-sm shadow-2xl safe-area-bottom flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4 flex-shrink-0">
                            <h3 className="text-lg font-bold text-white">{title ? 'ç·¨è¼¯ç›®æ¨™' : 'æ–°å¢ç›®æ¨™'}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><Icon name="x" className="w-6 h-6" /></button>
                        </div>
                        <div className="space-y-4 overflow-y-auto custom-scrollbar pr-2 flex-1">
                            <div>
                                <label className="text-xs text-slate-400 mb-1 block">ç›®æ¨™åç¨±</label>
                                <input 
                                    type="text" 
                                    value={newTitle} 
                                    onChange={(e) => setNewTitle(e.target.value)} 
                                    className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none" 
                                    placeholder="ä¾‹å¦‚ï¼šæ—¥æœ¬æ—…éŠåŸºé‡‘"
                                />
                            </div>
                            <div>
                                <label className="text-xs text-slate-400 mb-1 block">ç›®æ¨™é‡‘é¡</label>
                                <input 
                                    type="number" 
                                    value={newTarget} 
                                    onChange={(e) => setNewTarget(e.target.value)} 
                                    className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none" 
                                    placeholder="0"
                                />
                            </div>
                            <div>
                                <label className="text-xs text-slate-400 mb-1 block">ç›®æ¨™æœŸé™ (é¸å¡«)</label>
                                <div className="flex gap-2">
                                    <input 
                                        type="date" 
                                        value={newDeadline} 
                                        onChange={(e) => setNewDeadline(e.target.value)} 
                                        className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none" 
                                    />
                                    <button 
                                        onClick={() => setNewDeadline('')}
                                        className="p-3 bg-slate-900 border border-slate-600 rounded-lg text-slate-400 hover:text-white hover:border-slate-400"
                                        title="æ¸…é™¤æ—¥æœŸ"
                                    >
                                        <Icon name="x" className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="text-xs text-slate-400">ç¶å®šè³‡é‡‘ä¾†æº</label>
                                    <span className={`text-[10px] px-2 py-0.5 rounded-full border ${isTotalAssets ? 'border-emerald-500 text-emerald-400 bg-emerald-500/10' : 'border-blue-500 text-blue-400 bg-blue-500/10'}`}>
                                        {isTotalAssets ? 'âœ… ç›®å‰æ¨¡å¼ï¼šè¿½è¹¤ç¸½è³‡ç”¢' : 'ğŸ”¹ å°ˆæ¡ˆæ¨¡å¼'}
                                    </span>
                                </div>
                                <div className="space-y-3">
                                    {assetGroups.map(group => (
                                        group.items.length > 0 && (
                                            <div key={group.name}>
                                                <div className="text-[10px] text-slate-500 font-bold mb-1 uppercase tracking-wider">{group.name}</div>
                                                <div className="space-y-1">
                                                    {group.items.map(item => (
                                                        <div 
                                                            key={item.id} 
                                                            onClick={() => { playSfx('tap'); toggleLink(item.id); }}
                                                            className={`flex items-center justify-between p-2 rounded-lg cursor-pointer border transition-all ${selectedLinks.includes(item.id) ? 'bg-blue-600/20 border-blue-500' : 'bg-slate-900/50 border-transparent hover:bg-slate-900'}`}
                                                        >
                                                            <span className="text-xs text-slate-300 truncate max-w-[200px]">{item.name}</span>
                                                            {selectedLinks.includes(item.id) && <Icon name="check" className="w-3 h-3 text-blue-400" />}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )
                                    ))}
                                    {assetGroups.every(g => g.items.length === 0) && (
                                        <div className="text-xs text-slate-500 text-center py-2">ç„¡å¯ç”¨ç¾é‡‘å¸³æˆ¶</div>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="pt-4 mt-2 border-t border-slate-700 flex-shrink-0">
                             <button 
                                onClick={() => {
                                    if(newTitle && newTarget) {
                                        onConfirm(newTitle, newTarget, selectedLinks, newDeadline);
                                    }
                                }} 
                                className="w-full py-4 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold text-lg shadow-lg shadow-purple-600/20"
                            >
                                å„²å­˜è¨­å®š
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Modified CircularGoal ---
        const CircularGoal = ({ goal, current, target, onEdit, onDelete, isPrivacyMode, rates, cash, foreignCash }) => {
            
            const calculateProgress = () => {
                // If no linked accounts, use total net worth
                if (!goal.linkedAccounts || goal.linkedAccounts.length === 0) {
                    return current;
                }

                let sum = 0;
                // Helper to check and add
                const checkAdd = (items, isForeign = false) => {
                    items.forEach(item => {
                        if (goal.linkedAccounts.includes(item.id)) {
                            let val = 0;
                            if (isForeign) {
                                val = item.balance * (rates[item.currency] || 1);
                            } else {
                                val = item.balance;
                            }
                            sum += val;
                        }
                    });
                };

                checkAdd(cash);
                checkAdd(foreignCash, true);

                return sum;
            };

            // Get source names for display
            const getSourceNames = () => {
                if (!goal.linkedAccounts || goal.linkedAccounts.length === 0) return "å…¨è³‡ç”¢";
                
                const names = [];
                const checkNames = (items) => {
                    items.forEach(item => {
                        if (goal.linkedAccounts.includes(item.id)) names.push(item.name);
                    });
                };
                checkNames(cash);
                checkNames(foreignCash);
                
                if (names.length === 0) return "æœªçŸ¥ä¾†æº";
                if (names.length <= 2) return names.join(", ");
                return `${names[0]}... ç­‰ ${names.length} å€‹`;
            };

            const actualCurrent = calculateProgress();
            const percentage = Math.min(100, Math.max(0, (actualCurrent / target) * 100));
            const radius = 30;
            const stroke = 4;
            const normalizedRadius = radius - stroke * 2;
            const circumference = normalizedRadius * 2 * Math.PI;
            const strokeDashoffset = circumference - (percentage / 100) * circumference;

            // Days remaining logic
            let daysRemaining = null;
            if (goal.deadline) {
                const today = new Date();
                const due = new Date(goal.deadline);
                const diffTime = due - today;
                daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            }

            const sourceText = getSourceNames();

            return (
                <div className="glass-panel p-4 rounded-xl flex items-center justify-between">
                    <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                            <h3 className="text-sm font-bold text-white">{goal.title}</h3>
                            <button onClick={onEdit} className="text-slate-500 hover:text-blue-400"><Icon name="edit-2" className="w-3 h-3" /></button>
                            <button onClick={onDelete} className="text-slate-500 hover:text-red-400"><Icon name="trash" className="w-3 h-3" /></button>
                        </div>
                        <div className="flex items-center gap-2 mb-1">
                             <span className="text-[10px] px-1.5 py-0.5 rounded bg-slate-700 text-slate-300 max-w-[120px] truncate">{sourceText}</span>
                             <span className={`text-[10px] px-1.5 py-0.5 rounded ${daysRemaining !== null && daysRemaining < 0 ? 'bg-red-900/50 text-red-300' : 'bg-blue-900/50 text-blue-300'}`}>
                                 {daysRemaining === null ? 'âˆ ç„¡æœŸé™' : (daysRemaining < 0 ? `éæœŸ ${Math.abs(daysRemaining)} å¤©` : `å‰© ${daysRemaining} å¤©`)}
                             </span>
                        </div>
                        <div className="text-xs text-slate-400 mb-0.5">ç›®æ¨™: {isPrivacyMode ? '****' : formatMoney(target)}</div>
                        <div className="text-lg font-mono text-blue-400 font-bold">{isPrivacyMode ? '****' : formatMoney(actualCurrent)}</div>
                    </div>
                    <div className="relative w-20 h-20 flex items-center justify-center">
                        <svg height={radius * 2} width={radius * 2} className="rotate-[-90deg]">
                            <circle stroke="#1e293b" strokeWidth={stroke} r={normalizedRadius} cx={radius} cy={radius} fill="transparent" />
                            <circle stroke={percentage >= 100 ? '#10b981' : '#3b82f6'} strokeWidth={stroke} strokeDasharray={circumference + ' ' + circumference} style={{ strokeDashoffset, transition: 'stroke-dashoffset 1s ease-in-out' }} strokeLinecap="round" r={normalizedRadius} cx={radius} cy={radius} fill="transparent" />
                        </svg>
                        <span className="absolute text-xs font-bold text-white">{percentage.toFixed(0)}%</span>
                    </div>
                </div>
            );
        };

        // ... [Calculator, AssetTrendChart, AllocationBar, UpdateResultModal, DateRangeModal, SopInputModal, SopDetailsModal remain the same] ...
        const Calculator = ({ initialValue, onConfirm, playSfx }) => {
            const [display, setDisplay] = useState(String(initialValue));
            const [equation, setEquation] = useState('');
            const handleNum = (num) => { playSfx('tap'); if (display === '0' && num !== '.') setDisplay(num); else setDisplay(display + num); };
            const handleOp = (op) => { playSfx('tap'); setEquation(display + ' ' + op + ' '); setDisplay('0'); };
            const handleClear = () => { playSfx('delete'); setDisplay('0'); setEquation(''); };
            const handleEq = () => { try { const result = Function('"use strict";return (' + equation + display + ')')(); setDisplay(String(Math.round(result * 100) / 100)); setEquation(''); playSfx('success'); } catch (e) { setDisplay('Error'); } };
            return (
                <div className="w-full">
                    <div className="bg-slate-900 p-4 rounded-xl mb-4 text-right"><div className="text-slate-500 text-xs h-4">{equation}</div><div className="text-3xl font-mono text-white overflow-x-auto no-scrollbar">{display}</div></div>
                    <div className="calc-grid">
                        {['7','8','9','/'].map(b => <button key={b} onClick={() => isNaN(b) ? handleOp(b) : handleNum(b)} className={`calc-btn ${isNaN(b)?'op':''}`}>{b}</button>)}
                        {['4','5','6','*'].map(b => <button key={b} onClick={() => isNaN(b) ? handleOp(b) : handleNum(b)} className={`calc-btn ${isNaN(b)?'op':''}`}>{b}</button>)}
                        {['1','2','3','-'].map(b => <button key={b} onClick={() => isNaN(b) ? handleOp(b) : handleNum(b)} className={`calc-btn ${isNaN(b)?'op':''}`}>{b}</button>)}
                        <button onClick={handleClear} className="calc-btn text-red-400">C</button>
                        <button onClick={() => handleNum('0')} className="calc-btn">0</button>
                        <button onClick={handleEq} className="calc-btn text-emerald-400">=</button>
                        <button onClick={() => handleOp('+')} className="calc-btn op">+</button>
                    </div>
                    <button onClick={() => onConfirm(display)} className="w-full mt-6 py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg">ç¢ºèªæ›´æ–°</button>
                </div>
            );
        };

        const AssetTrendChart = ({ history, timeRange, mode, customDates, isPrivacyMode }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const scrollContainerRef = useRef(null);
            
            const filteredData = useMemo(() => {
                if(!history || history.length === 0) return [];
                
                const parseDate = (str) => new Date(str.replace(/-/g, '/')); 
                let chartHistory = [...history];
                chartHistory.sort((a, b) => a.date.localeCompare(b.date));

                let rangeData = [];
                if (timeRange === 'CUSTOM' && customDates.start && customDates.end) {
                     const s = parseDate(customDates.start);
                     const e = parseDate(customDates.end);
                     rangeData = chartHistory.filter(h => { const d = parseDate(h.date); return d >= s && d <= e; });
                } else if (timeRange === 'æ—¥') { 
                     rangeData = chartHistory;
                } else {
                     rangeData = chartHistory;
                }

                if (timeRange === 'æ—¥' || timeRange === 'CUSTOM') return rangeData;

                const groups = {};
                rangeData.forEach(item => {
                    const d = parseDate(item.date);
                    let key;
                    if (timeRange === 'æœˆ') {
                        key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    } else if (timeRange === 'å¹´') {
                        key = `${d.getFullYear()}`;
                    }
                    groups[key] = item; 
                });
                return Object.values(groups).sort((a, b) => a.date.localeCompare(b.date));
            }, [history, timeRange, customDates]);

            const displayData = useMemo(() => {
                return filteredData.map(h => {
                    if (mode === 'total') return h.total;
                    if (mode === 'cashTW') return h.cashTW || 0;
                    if (mode === 'stockTW') return h.stockTW || 0;
                    if (mode === 'cashForeign') return h.cashForeign || 0;
                    if (mode === 'stockForeign') return h.stockForeign || 0;
                    return 0;
                });
            }, [filteredData, mode]);

            const labels = useMemo(() => {
                return filteredData.map(h => {
                    if (timeRange === 'å¹´') return h.date.substring(0, 4);
                    if (timeRange === 'æœˆ') return h.date.substring(0, 7);
                    return h.date.slice(5).replace('-', '/');
                });
            }, [filteredData, timeRange]);

            useEffect(() => {
                if (chartInstance.current) chartInstance.current.destroy();
                const ctx = chartRef.current.getContext('2d');
                
                let color = '#3b82f6';
                if (mode === 'cashTW') color = '#10b981'; if (mode === 'stockTW') color = '#0ea5e9'; if (mode === 'cashForeign') color = '#a855f7'; if (mode === 'stockForeign') color = '#ec4899';
                
                const gradient = ctx.createLinearGradient(0, 0, 0, 300); 
                gradient.addColorStop(0, color + '80'); 
                gradient.addColorStop(1, color + '00');
                
                // Styling arrays for highlighting the last point
                const pointRadii = displayData.map((_, i) => i === displayData.length - 1 ? 6 : 3);
                const pointColors = displayData.map((_, i) => i === displayData.length - 1 ? '#ffffff' : color);
                const pointBorders = displayData.map((_, i) => i === displayData.length - 1 ? color : color);
                const pointBorderWidths = displayData.map((_, i) => i === displayData.length - 1 ? 3 : 0);

                chartInstance.current = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        labels: labels, 
                        datasets: [{ 
                            data: displayData, 
                            borderColor: color, 
                            backgroundColor: gradient, 
                            borderWidth: 2, 
                            // Custom Point Styling
                            pointRadius: pointRadii,
                            pointBackgroundColor: pointColors,
                            pointBorderColor: pointBorders,
                            pointBorderWidth: pointBorderWidths,
                            pointHitRadius: 20, // Easy to tap anywhere
                            pointHoverRadius: 6,
                            fill: true, 
                            tension: 0.4 
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        interaction: { intersect: false, mode: 'index' }, 
                        plugins: { 
                            legend: { display: false }, 
                            tooltip: { 
                                enabled: true,
                                callbacks: { label: (ctx) => ` ${new Intl.NumberFormat('zh-TW', {style: 'currency', currency: 'TWD', currencyDisplay: 'code', maximumFractionDigits: 0}).format(ctx.parsed.y).replace('TWD', 'NTD')}` }
                            }
                        }, 
                        scales: { 
                            x: { 
                                grid: { display: false, drawBorder: false }, 
                                ticks: { color: '#64748b', font: {size: 10}, maxRotation: 0, autoSkip: false } 
                            }, 
                            y: { 
                                display: false, // HIDE Y-Axis
                                grid: { color: '#1e293b' } 
                            } 
                        },
                        layout: { padding: { left: 10, right: 20, top: 20, bottom: 10 } }
                    } 
                });
                
                if (scrollContainerRef.current) {
                    scrollContainerRef.current.scrollLeft = scrollContainerRef.current.scrollWidth;
                }

            }, [filteredData, displayData, labels, mode]);

            const calculatedWidth = Math.max(100, (displayData.length / 7) * 100);

            return (
                <div className={`w-full h-48 flex transition-all duration-300 ${isPrivacyMode ? 'blur-content' : 'no-blur'}`}>
                    <div ref={scrollContainerRef} className="flex-1 h-full overflow-x-auto no-scrollbar relative">
                        <div style={{ width: `${calculatedWidth}%`, height: '100%' }}>
                            <canvas ref={chartRef} />
                        </div>
                    </div>
                </div>
            );
        };

        const AllocationBar = ({ cash, tw, us, total, isPrivacyMode, playSfx }) => {
            if (total === 0) return <div className="text-center text-xs text-slate-500 py-4">ç„¡è³‡ç”¢æ•¸æ“š</div>;
            const pCash = (cash / total) * 100; const pTw = (tw / total) * 100; const pUs = (us / total) * 100;
            const [selected, setSelected] = useState(null);
            const displayVal = (val) => isPrivacyMode ? '****' : formatMoney(val);
            const handleSelect = (type) => { playSfx('tap'); setSelected(selected === type ? null : type); };
            return (
                <div className={`w-full transition-all duration-300 ${isPrivacyMode ? 'blur-sm' : ''}`}>
                    <div className="h-6 w-full flex rounded-full overflow-hidden cursor-pointer mb-3">
                        <div style={{ width: `${pCash}%` }} className="bg-emerald-500 hover:opacity-90 transition-opacity" onClick={() => handleSelect('cash')}></div>
                        <div style={{ width: `${pTw}%` }} className="bg-sky-500 hover:opacity-90 transition-opacity" onClick={() => handleSelect('tw')}></div>
                        <div style={{ width: `${pUs}%` }} className="bg-purple-500 hover:opacity-90 transition-opacity" onClick={() => handleSelect('us')}></div>
                    </div>
                    <div className="grid grid-cols-3 gap-2 text-center">
                        <div className={`p-2 rounded-lg transition-colors cursor-pointer ${selected === 'cash' ? 'bg-emerald-500/10 ring-1 ring-emerald-500' : 'hover:bg-white/5'}`} onClick={() => handleSelect('cash')}><div className="flex items-center justify-center space-x-1 mb-1"><div className="w-2 h-2 rounded-full bg-emerald-500"></div><span className="text-xs text-slate-400">ç¾é‡‘</span></div><div className="text-sm font-bold text-white">{pCash.toFixed(0)}%</div>{selected === 'cash' && <div className="text-[10px] text-emerald-400 font-mono mt-1">{displayVal(cash)}</div>}</div>
                        <div className={`p-2 rounded-lg transition-colors cursor-pointer ${selected === 'tw' ? 'bg-sky-500/10 ring-1 ring-sky-500' : 'hover:bg-white/5'}`} onClick={() => handleSelect('tw')}><div className="flex items-center justify-center space-x-1 mb-1"><div className="w-2 h-2 rounded-full bg-sky-500"></div><span className="text-xs text-slate-400">å°è‚¡</span></div><div className="text-sm font-bold text-white">{pTw.toFixed(0)}%</div>{selected === 'tw' && <div className="text-[10px] text-sky-400 font-mono mt-1">{displayVal(tw)}</div>}</div>
                        <div className={`p-2 rounded-lg transition-colors cursor-pointer ${selected === 'us' ? 'bg-purple-500/10 ring-1 ring-purple-500' : 'hover:bg-white/5'}`} onClick={() => handleSelect('us')}><div className="flex items-center justify-center space-x-1 mb-1"><div className="w-2 h-2 rounded-full bg-purple-500"></div><span className="text-xs text-slate-400">å¤–è³‡</span></div><div className="text-sm font-bold text-white">{pUs.toFixed(0)}%</div>{selected === 'us' && <div className="text-[10px] text-purple-400 font-mono mt-1">{displayVal(us)}</div>}</div>
                    </div>
                </div>
            );
        };

        const UpdateResultModal = ({ results, onClose, isPrivacyMode }) => {
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center z-[200] p-6 animate-fade-in" onClick={onClose}>
                    <div className="bg-slate-800 border-t sm:border border-slate-700 rounded-t-2xl sm:rounded-2xl p-6 w-full max-w-sm shadow-2xl relative safe-area-bottom" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-white flex items-center"><Icon name="activity" className="w-5 h-5 mr-2 text-emerald-400" /> æ›´æ–°å ±å‘Š</h3><button onClick={onClose} className="text-slate-400"><Icon name="x" className="w-5 h-5" /></button></div>
                        <div className="space-y-3 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">{results.length === 0 ? <p className="text-slate-400 text-center text-sm">æ•¸æ“šç„¡è®Šå‹•</p> : results.map((item, idx) => (<div key={idx} className="bg-slate-900/50 p-3 rounded-lg flex justify-between items-center text-xs"><span className="text-slate-300 font-mono">{item.label}</span><span className={`${item.diff > 0 ? 'text-emerald-400' : item.diff < 0 ? 'text-red-400' : 'text-slate-400'}`}>{isPrivacyMode && item.label.includes('è³‡ç”¢') ? '****' : item.value}</span></div>))}</div>
                        <button onClick={onClose} className="w-full mt-4 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-sm">é—œé–‰</button>
                    </div>
                </div>
            );
        };
        const DateRangeModal = ({ currentDates, onConfirm, onClose }) => {
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center z-[200] sm:p-6 animate-fade-in" onClick={onClose}>
                    <div className="bg-slate-800 border-t sm:border border-slate-700 rounded-t-2xl sm:rounded-2xl p-6 w-full max-w-sm shadow-2xl relative safe-area-bottom" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6"><h3 className="text-lg font-bold text-white flex items-center"><Icon name="calendar" className="w-5 h-5 mr-2 text-blue-400" /> è‡ªè¨‚å€é–“</h3><button onClick={onClose} className="text-slate-400"><Icon name="x" className="w-5 h-5" /></button></div>
                        <div className="space-y-4"><div><label className="block text-xs text-slate-400 mb-2">é–‹å§‹æ—¥æœŸ</label><input id="startDate" type="date" defaultValue={currentDates.start} className="bg-slate-900 border border-slate-600 rounded-xl p-4 w-full text-white font-mono text-base focus:border-blue-500 outline-none" /></div><div><label className="block text-xs text-slate-400 mb-2">çµæŸæ—¥æœŸ</label><input id="endDate" type="date" defaultValue={currentDates.end} className="bg-slate-900 border border-slate-600 rounded-xl p-4 w-full text-white font-mono text-base focus:border-blue-500 outline-none" /></div></div>
                        <button onClick={() => { const s = document.getElementById('startDate').value; const e = document.getElementById('endDate').value; if (s && e) onConfirm(s, e); }} className="w-full mt-6 py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg">ç¢ºèª</button>
                    </div>
                </div>
            );
        };
        const SopInputModal = ({ title, defaultValue, onConfirm, onClose }) => {
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center z-[200] sm:p-6 animate-fade-in" onClick={onClose}>
                    <div className="bg-slate-800 border-t sm:border border-slate-700 rounded-t-2xl sm:rounded-2xl p-6 w-full max-w-sm shadow-2xl safe-area-bottom" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6"><h3 className="text-lg font-bold text-white">{title}</h3><button onClick={onClose} className="text-slate-400 hover:text-white"><Icon name="x" className="w-6 h-6" /></button></div>
                        <div className="space-y-4 mb-6"><input id="sop-modal-input" type="text" defaultValue={defaultValue} autoFocus className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none text-base" placeholder="è«‹è¼¸å…¥å…§å®¹..." onKeyDown={(e) => { if (e.key === 'Enter') onConfirm(e.target.value); }} /></div>
                        <button onClick={() => onConfirm(document.getElementById('sop-modal-input').value)} className="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg">ç¢ºèª</button>
                    </div>
                </div>
            );
        };

        const SopDetailsModal = ({ sopDetails, setSopDetails, onClose, playSfx }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [inputModal, setInputModal] = useState(null); 
            const [confirmDeleteIdx, setConfirmDeleteIdx] = useState(null); 
            const [confirmDeleteStep, setConfirmDeleteStep] = useState(null); 

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [isEditing, sopDetails]);

            const openInput = (type, sectionIdx, stepIdx, value) => {
                playSfx('pop');
                setInputModal({ type, sectionIdx, stepIdx, value });
            };

            const handleInputConfirm = (val) => {
                if (!val) { setInputModal(null); return; }
                const newDetails = [...sopDetails];
                if (inputModal.type === 'addSection') newDetails.push({ title: val, steps: [] });
                else if (inputModal.type === 'editSection') newDetails[inputModal.sectionIdx].title = val;
                else if (inputModal.type === 'addStep') newDetails[inputModal.sectionIdx].steps.push(val);
                else if (inputModal.type === 'editStep') newDetails[inputModal.sectionIdx].steps[inputModal.stepIdx] = val;
                setSopDetails(newDetails); setInputModal(null); playSfx('success');
            };

            const handleDeleteSection = (idx) => { if (confirmDeleteIdx === idx) { playSfx('delete'); setSopDetails(sopDetails.filter((_, i) => i !== idx)); setConfirmDeleteIdx(null); } else { playSfx('tap'); setConfirmDeleteIdx(idx); setTimeout(() => setConfirmDeleteIdx(null), 3000); } };
            const handleDeleteStep = (sectionIdx, stepIdx) => { if (confirmDeleteStep && confirmDeleteStep.sIdx === sectionIdx && confirmDeleteStep.stIdx === stepIdx) { playSfx('delete'); const newDetails = [...sopDetails]; newDetails[sectionIdx].steps = newDetails[sectionIdx].steps.filter((_, i) => i !== stepIdx); setSopDetails(newDetails); setConfirmDeleteStep(null); } else { playSfx('tap'); setConfirmDeleteStep({ sIdx: sectionIdx, stIdx: stepIdx }); setTimeout(() => setConfirmDeleteStep(null), 3000); } };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100] p-6 animate-fade-in" onClick={onClose}>
                    <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6 w-full max-w-sm shadow-2xl relative flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4 flex-shrink-0"><h3 className="text-lg font-bold text-white flex items-center"><Icon name="book-open" className="w-5 h-5 mr-2 text-yellow-400" /> æ¨™æº–æ“ä½œ SOP</h3><div className="flex items-center gap-2"><button onClick={() => { playSfx('tap'); setIsEditing(!isEditing); }} className={`text-xs px-2 py-1 rounded ${isEditing ? 'bg-blue-600 text-white' : 'text-blue-400 border border-blue-400'}`}>{isEditing ? 'å®Œæˆ' : 'ç·¨è¼¯'}</button><button onClick={onClose} className="text-slate-400"><Icon name="x" className="w-5 h-5" /></button></div></div>
                        <div className="space-y-4 overflow-y-auto custom-scrollbar pr-2 flex-1">{sopDetails.length > 0 ? sopDetails.map((section, idx) => (<div key={idx} className="bg-slate-900/50 p-3 rounded-lg relative group">{isEditing && (<button onClick={() => handleDeleteSection(idx)} className={`absolute top-2 right-2 p-1 transition-colors ${confirmDeleteIdx === idx ? 'text-red-500 bg-red-500/10 rounded font-bold text-xs' : 'text-slate-500 opacity-50 hover:opacity-100 hover:text-red-400'}`}>{confirmDeleteIdx === idx ? 'ç¢ºå®š?' : <Icon name="trash-2" className="w-4 h-4" />}</button>)}<div onClick={() => isEditing && openInput('editSection', idx, null, section.title)} className={`text-sm font-bold mb-2 flex items-center ${isEditing ? 'text-blue-300 cursor-pointer hover:bg-white/5 p-1 rounded' : 'text-blue-400'}`}>{section.title}{isEditing && <Icon name="edit-2" className="w-3 h-3 ml-2 opacity-50" />}</div><ul className="list-disc list-inside text-xs text-slate-300 space-y-1">{section.steps.map((step, sIdx) => (<li key={sIdx} className="flex items-center justify-between group/step py-1"><span onClick={() => isEditing && openInput('editStep', idx, sIdx, step)} className={`flex-1 ${isEditing ? 'cursor-pointer hover:text-white border-b border-dashed border-slate-600 pb-0.5' : ''}`}>{step}</span>{isEditing && (<button onClick={() => handleDeleteStep(idx, sIdx)} className={`ml-2 p-1 transition-colors ${confirmDeleteStep && confirmDeleteStep.sIdx === idx && confirmDeleteStep.stIdx === sIdx ? 'text-red-500 font-bold text-[10px]' : 'text-red-400 opacity-50 hover:opacity-100'}`}>{confirmDeleteStep && confirmDeleteStep.sIdx === idx && confirmDeleteStep.stIdx === sIdx ? 'åˆªé™¤?' : <Icon name="minus-circle" className="w-3 h-3" />}</button>)}</li>))}{isEditing && (<li className="list-none pt-2"><button onClick={() => openInput('addStep', idx)} className="text-xs text-emerald-400 flex items-center p-1 hover:bg-white/5 rounded"><Icon name="plus" className="w-3 h-3 mr-1" /> æ–°å¢æ­¥é©Ÿ</button></li>)}</ul></div>)) : <div className="text-slate-500 text-xs text-center py-4">ç„¡ SOP è©³ç´°èªªæ˜</div>}{isEditing && (<button onClick={() => openInput('addSection')} className="w-full py-3 border border-dashed border-slate-600 text-slate-400 rounded-lg text-xs hover:border-slate-400 hover:text-white transition-colors">+ æ–°å¢ç« ç¯€</button>)}</div> {inputModal && (<SopInputModal title={inputModal.type === 'addSection' ? 'æ–°å¢ç« ç¯€' : inputModal.type === 'editSection' ? 'ç·¨è¼¯ç« ç¯€' : inputModal.type === 'addStep' ? 'æ–°å¢æ­¥é©Ÿ' : 'ç·¨è¼¯æ­¥é©Ÿ'} defaultValue={inputModal.value || ''} onConfirm={handleInputConfirm} onClose={() => { playSfx('pop'); setInputModal(null); }} />)} </div> </div> ); };

        // ---ä¸»ç¨‹å¼ (Updated for V22.1) ---
        const App = () => {
            const [cash, setCash] = useState(() => JSON.parse(localStorage.getItem('ap_cash')) || INITIAL_CASH);
            const [twStocks, setTwStocks] = useState(() => JSON.parse(localStorage.getItem('ap_tw_stocks')) || INITIAL_TW_STOCKS);
            const [foreignStocks, setForeignStocks] = useState(() => { const saved = localStorage.getItem('ap_foreign_stocks'); if (saved) return JSON.parse(saved); const oldUs = localStorage.getItem('ap_us_stocks'); if (oldUs) { const parsed = JSON.parse(oldUs); return parsed.map(s => ({ ...s, currency: 'USD' })); } return INITIAL_FOREIGN_CASH; });
            const [foreignCash, setForeignCash] = useState(() => { const saved = localStorage.getItem('ap_foreign_cash_list'); if (saved) return JSON.parse(saved); const oldUsCash = localStorage.getItem('ap_us_cash'); if (oldUsCash && parseFloat(oldUsCash) > 0) { return [{ id: 'migrated_usd', name: 'Firstrade é¤˜é¡', balance: parseFloat(oldUsCash), currency: 'USD' }]; } return INITIAL_FOREIGN_CASH; });
            const [goals, setGoals] = useState(() => JSON.parse(localStorage.getItem('ap_goals')) || INITIAL_GOALS);
            const [sopList, setSopList] = useState(() => JSON.parse(localStorage.getItem('ap_sop')) || INITIAL_SOP);
            const [sopDetails, setSopDetails] = useState(() => JSON.parse(localStorage.getItem('ap_sop_details')) || INITIAL_SOP_DETAILS);
            const [rates, setRates] = useState(() => { const saved = localStorage.getItem('ap_rates_map'); const savedRates = saved ? JSON.parse(saved) : {}; return { ...INITIAL_RATES, ...savedRates }; });
            const [history, setHistory] = useState(() => JSON.parse(localStorage.getItem('ap_history_v3')) || generateCorrectedHistory());
            const [walletOrder, setWalletOrder] = useState(() => { const saved = localStorage.getItem('ap_wallet_order'); return saved ? JSON.parse(saved) : ['cashTW', 'cashForeign', 'stockForeign', 'stockTW']; });
            const [userName, setUserName] = useState(() => localStorage.getItem('ap_user_name') || 'User');
            const [soundEnabled, setSoundEnabled] = useState(() => { const saved = localStorage.getItem('ap_sound_enabled'); return saved !== null ? JSON.parse(saved) : true; });
            const [showWelcome, setShowWelcome] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '' });
            const [showTutorial, setShowTutorial] = useState(false);
            const [tutorialStep, setTutorialStep] = useState(0);
            const [isPrivacyMode, setIsPrivacyMode] = useState(false); 
            const [activeTab, setActiveTab] = useState('dashboard');
            const [trendMode, setTrendMode] = useState('total'); 
            const [timeRange, setTimeRange] = useState('æ—¥'); 
            const [customDates, setCustomDates] = useState({ start: '', end: '' }); 
            const [editItem, setEditItem] = useState(null);
            const [deleteConfirm, setDeleteConfirm] = useState(false);
            const [addItemType, setAddItemType] = useState(null);
            const [editGoal, setEditGoal] = useState(null);
            const [sopEditMode, setSopEditMode] = useState(false);
            const [showSopModal, setShowSopModal] = useState(false);
            const [showSettings, setShowSettings] = useState(false); 
            const [showDateModal, setShowDateModal] = useState(false);
            const [isUpdating, setIsUpdating] = useState(false);
            const [lastUpdate, setLastUpdate] = useState(null);
            const [updateResults, setUpdateResults] = useState(null);
            const [sopTaskInput, setSopTaskInput] = useState(null);

            useEffect(() => { const seen = localStorage.getItem('ap_tutorial_seen'); if (!seen) { setShowWelcome(true); } }, []);
            useEffect(() => { if (showTutorial) { const step = TUTORIAL_STEPS[tutorialStep]; if (step.tab && step.tab !== activeTab) { setActiveTab(step.tab); } } }, [showTutorial, tutorialStep]);
            useEffect(() => { localStorage.setItem('ap_cash', JSON.stringify(cash)); }, [cash]);
            useEffect(() => { localStorage.setItem('ap_tw_stocks', JSON.stringify(twStocks)); }, [twStocks]);
            useEffect(() => { localStorage.setItem('ap_foreign_stocks', JSON.stringify(foreignStocks)); }, [foreignStocks]);
            useEffect(() => { localStorage.setItem('ap_foreign_cash_list', JSON.stringify(foreignCash)); }, [foreignCash]);
            useEffect(() => { localStorage.setItem('ap_goals', JSON.stringify(goals)); }, [goals]);
            useEffect(() => { localStorage.setItem('ap_sop', JSON.stringify(sopList)); }, [sopList]);
            useEffect(() => { localStorage.setItem('ap_sop_details', JSON.stringify(sopDetails)); }, [sopDetails]);
            useEffect(() => { localStorage.setItem('ap_rates_map', JSON.stringify(rates)); }, [rates]);
            useEffect(() => { localStorage.setItem('ap_history_v3', JSON.stringify(history)); }, [history]);
            useEffect(() => { localStorage.setItem('ap_wallet_order', JSON.stringify(walletOrder)); }, [walletOrder]);
            useEffect(() => { localStorage.setItem('ap_user_name', userName); }, [userName]);
            useEffect(() => { localStorage.setItem('ap_sound_enabled', JSON.stringify(soundEnabled)); }, [soundEnabled]);
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            const triggerToast = (message) => { setToast({ show: true, message }); setTimeout(() => setToast({ show: false, message: '' }), 3000); };
            const playSfx = (type) => { if (soundEnabled) SoundEngine.play(type); };
            const handleWelcomeConfirm = (name) => { setUserName(name); localStorage.setItem('ap_user_name', name); playSfx('success'); setShowWelcome(false); setTimeout(() => { setShowTutorial(true); }, 500); };
            const handleTutorialNext = () => { playSfx('tap'); if (tutorialStep < TUTORIAL_STEPS.length - 1) { setTutorialStep(prev => prev + 1); } else { handleTutorialClose(); } };
            const handleTutorialPrev = () => { playSfx('tap'); if (tutorialStep > 0) setTutorialStep(prev => prev - 1); };
            const handleTutorialClose = () => { playSfx('success'); setShowTutorial(false); setTutorialStep(0); setActiveTab('dashboard'); localStorage.setItem('ap_tutorial_seen', 'true'); triggerToast("å°è¦½å®Œæˆï¼é–‹å§‹æ¢ç´¢å§"); };
            const replayTutorial = () => { playSfx('tap'); setShowTutorial(true); setTutorialStep(0); setShowSettings(false); };

            const totalCashTWD = useMemo(() => cash.reduce((acc, curr) => acc + (curr.balance || 0), 0), [cash]);
            const totalTwStocksTWD = useMemo(() => twStocks.reduce((acc, curr) => acc + (curr.shares * curr.price), 0), [twStocks]);
            const totalForeignStocksTWD = useMemo(() => foreignStocks.reduce((acc, s) => { const rate = rates[s.currency] || 1; return acc + (s.price * s.shares * rate); }, 0), [foreignStocks, rates]);
            const totalForeignCashTWD = useMemo(() => foreignCash.reduce((acc, c) => { const rate = rates[c.currency] || 1; return acc + ((c.balance || 0) * rate); }, 0), [foreignCash, rates]);
            const totalNetWorth = totalCashTWD + totalTwStocksTWD + totalForeignStocksTWD + totalForeignCashTWD;
            const totalForeignAssetsTWD = totalForeignStocksTWD + totalForeignCashTWD;
            const activeCurrencies = useMemo(() => { const currencies = new Set(['USD']); foreignStocks.forEach(s => currencies.add(s.currency)); foreignCash.forEach(c => currencies.add(c.currency)); return Array.from(currencies); }, [foreignStocks, foreignCash]);
            const displayMoney = (val) => isPrivacyMode ? '****' : formatMoney(val);
            const displayForeign = (val, cur) => isPrivacyMode ? '****' : formatForeign(val, cur);

            useEffect(() => {
                if (isNaN(totalNetWorth) || (totalNetWorth === 0 && history.length === 0)) return;
                const today = getLocalDateString();
                const lastRecord = history[history.length - 1];
                const newRecord = { date: today, cashTW: Math.round(totalCashTWD), stockTW: Math.round(totalTwStocksTWD), cashForeign: Math.round(totalForeignCashTWD), stockForeign: Math.round(totalForeignStocksTWD), total: Math.round(totalNetWorth) };
                if (history.length === 0) { setHistory([newRecord]); } else if (lastRecord.date !== today) { setHistory(prev => [...prev, newRecord]); } else if (Math.abs(lastRecord.total - totalNetWorth) > 100) { setHistory(prev => [...prev.slice(0, -1), newRecord]); }
            }, [totalNetWorth]);

            const ytdStats = useMemo(() => { if (history.length === 0) return { diff: 0, percent: 0 }; const latest = history[history.length - 1]; const currentYear = new Date().getFullYear(); let base = history.find(h => new Date(h.date.replace(/-/g, '/')).getFullYear() === currentYear); if (!base) base = latest; const diff = latest.total - base.total; const percent = base.total !== 0 ? (diff / base.total) * 100 : 0; return { diff, percent }; }, [history]);
            const monthlyReportData = useMemo(() => { const report = {}; history.forEach(rec => { const month = rec.date.substring(0, 7); if (!report[month] || rec.date > report[month].date) report[month] = rec; }); return Object.values(report).sort((a, b) => b.date.localeCompare(a.date)); }, [history]);
            const fetchYahooData = async (ticker) => { const timestamp = new Date().getTime(); try { const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d&_t=${timestamp}`; const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`; const res = await fetch(proxyUrl, { cache: "no-store" }); const data = await res.json(); const meta = data?.chart?.result?.[0]?.meta; return { price: meta?.regularMarketPrice || null, name: meta?.longName || meta?.shortName || null }; } catch (e) { console.error(`Failed to fetch ${ticker}`, e); return { price: null, name: null }; } };
            const fetchLiveData = async () => { setIsUpdating(true); playSfx('tap'); const reportLogs = []; const oldNetWorth = totalNetWorth; let newRates = { ...rates }; try { for (const currency of activeCurrencies) { if (currency === 'TWD') continue; try { const ticker = currency === 'USD' ? 'TWD=X' : `${currency}TWD=X`; const { price: rate } = await fetchYahooData(ticker); if (rate) { const oldRate = rates[currency] || 0; if (Math.abs(rate - oldRate) > 0.001) { reportLogs.push({ label: `${currency} åŒ¯ç‡`, value: `${oldRate.toFixed(2)} -> ${rate.toFixed(2)}`, diff: rate - oldRate }); newRates[currency] = rate; } } } catch (e) { console.warn(`Failed to fetch rate for ${currency}`, e); } } setRates(newRates); const newForeignStocks = await Promise.all(foreignStocks.map(async (s) => { const { price, name } = await fetchYahooData(s.ticker); let updatedS = { ...s }; if (name && (s.name === s.ticker || s.name === s.ticker.split('.')[0])) updatedS.name = name; if (price && price !== s.price) { reportLogs.push({ label: updatedS.name, value: `${s.price.toFixed(2)} -> ${price.toFixed(2)}`, diff: price - s.price }); updatedS.price = price; } return updatedS; })); const newTwStocks = await Promise.all(twStocks.map(async (s) => { const { price, name } = await fetchYahooData(s.ticker); let updatedS = { ...s }; if (name && (s.name === s.ticker || s.name === s.ticker.split('.')[0])) updatedS.name = name; if (price && price !== s.price) { reportLogs.push({ label: updatedS.name, value: `${s.price.toFixed(2)} -> ${price.toFixed(2)}`, diff: price - s.price }); updatedS.price = price; } return updatedS; })); setForeignStocks(newForeignStocks); setTwStocks(newTwStocks); const newTwTotal = newTwStocks.reduce((acc, curr) => acc + (curr.shares * curr.price), 0); const newForeignStocksTotal = newForeignStocks.reduce((acc, curr) => acc + (curr.shares * curr.price * (newRates[curr.currency]||1)), 0); const newForeignCashTotal = foreignCash.reduce((acc, curr) => acc + (curr.balance * (newRates[curr.currency]||1)), 0); const newTotalNetWorth = totalCashTWD + newTwTotal + newForeignStocksTotal + newForeignCashTotal; if (!isNaN(newTotalNetWorth) && Math.abs(newTotalNetWorth - oldNetWorth) > 1) { reportLogs.unshift({ label: 'ç¸½è³‡ç”¢è®Šå‹•', value: `${formatMoney(oldNetWorth)} -> ${formatMoney(newTotalNetWorth)}`, diff: newTotalNetWorth - oldNetWorth }); } setLastUpdate(new Date().toLocaleTimeString()); setUpdateResults(reportLogs); triggerToast('å³æ™‚å ±åƒ¹æ›´æ–°å®Œæˆ'); playSfx('success'); } catch (error) { console.error(error); } finally { setIsUpdating(false); } };
            const exportData = () => { playSfx('success'); const data = { cash, twStocks, foreignStocks, foreignCash, goals, sopList, sopDetails, history, rates, walletOrder, userName }; const blob = new Blob([JSON.stringify(data)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `assetpilot_backup_v22.1_${new Date().toISOString().slice(0,10)}.json`; a.click(); };
            const importData = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (confirm('ç¢ºå®šè¦é‚„åŸå‚™ä»½è³‡æ–™å—ï¼Ÿ')) { if(data.cash) setCash(data.cash); if(data.twStocks) setTwStocks(data.twStocks); if(data.foreignStocks) setForeignStocks(data.foreignStocks); if(data.foreignCash) setForeignCash(data.foreignCash); if(data.goals) setGoals(data.goals); if(data.sopList) setSopList(data.sopList); if(data.sopDetails) setSopDetails(data.sopDetails); if(data.history) setHistory(data.history); if(data.rates) setRates(data.rates); if(data.walletOrder) setWalletOrder(data.walletOrder); if(data.userName) setUserName(data.userName); playSfx('success'); triggerToast('è³‡æ–™é‚„åŸæˆåŠŸ'); setShowSettings(false); } } catch (err) { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); } }; reader.readAsText(file); };
            const openEditItem = (itemData) => { playSfx('pop'); setDeleteConfirm(false); setEditItem(itemData); };
            const performDelete = (id, type) => { if (!id) return; if(type==='cash') setCash(p=>p.filter(i=>i.id!==id)); else if(type==='stockTW') setTwStocks(p=>p.filter(i=>i.id!==id)); else if(type==='stockForeign') setForeignStocks(p=>p.filter(i=>i.id!==id)); else if(type==='cashForeign') setForeignCash(p=>p.filter(i=>i.id!==id)); setEditItem(null); playSfx('delete'); triggerToast('åˆªé™¤æˆåŠŸ'); };
            const handleAddItem = async (type, v1, v2, v3, v4, v5) => { const id=Math.random().toString(36).substr(2,9); if (type==='cash') { setCash([...cash,{id,name:v1,balance:parseFloat(v2)||0, note: v5, locked:false}]); setAddItemType(null); } else if (type === 'cashForeign') { setForeignCash([...foreignCash, {id, name: v1, balance: parseFloat(v2)||0, currency: v3 || 'USD', note: v5}]); setAddItemType(null); } else { let ticker = v1.toUpperCase(); if (type === 'stockTW' && !ticker.includes('.')) ticker += '.TW'; const name = v2 || ticker; const shares = parseFloat(v3)||0; const currency = v4 || (type === 'stockTW' ? 'TWD' : 'USD'); const note = v5; const newItem = {id, ticker, name, shares, price: 0, currency, note}; if (type === 'stockTW') setTwStocks(prev => [...prev, newItem]); else setForeignStocks(prev => [...prev, newItem]); setAddItemType(null); if (!v2) { try { const { price, name: fetchedName } = await fetchYahooData(ticker); const updateFunc = type === 'stockTW' ? setTwStocks : setForeignStocks; updateFunc(prev => prev.map(item => { if (item.id === id) { return { ...item, name: fetchedName || item.name, price: price || 0 }; } return item; })); } catch (e) { console.error("Auto-fetch name failed", e); } } } playSfx('success'); triggerToast('æ–°å¢æˆåŠŸ'); };
            const handleUpdateValue = (id, type, val, newName, newNote) => { const num = parseFloat(val); const updater = (item) => { if (item.id !== id) return item; let updated = { ...item }; if (type.includes('cash')) updated.balance = num; else updated.shares = num; if (newName !== undefined) updated.name = newName; if (newNote !== undefined) updated.note = newNote; return updated; }; if(type==='cash') setCash(p => p.map(updater)); else if(type==='cashForeign') setForeignCash(p => p.map(updater)); else if(type==='stockTW') setTwStocks(p => p.map(updater)); else setForeignStocks(p => p.map(updater)); setEditItem(null); playSfx('success'); triggerToast('æ›´æ–°æˆåŠŸ'); };
            const toggleSop = (id) => { playSfx('tap'); setSopList(prev => prev.map(s => s.id === id ? { ...s, completed: !s.completed } : s)); };
            const deleteSop=(id)=> { playSfx('delete'); setSopList(p=>p.filter(s=>s.id!==id)); };
            const addSop = () => { playSfx('pop'); setSopTaskInput({ id: null, text: '' }); };
            const editSopText = (id, text) => { playSfx('pop'); setSopTaskInput({ id, text }); };
            const handleSaveSopTask = (text) => { if (text.trim() === '') return; if (sopTaskInput.id) { setSopList(prev => prev.map(s => s.id === sopTaskInput.id ? { ...s, text } : s)); triggerToast('ä»»å‹™å·²æ›´æ–°'); } else { setSopList([...sopList, { id: Date.now(), text, completed: false }]); triggerToast('ä»»å‹™å·²æ–°å¢'); } setSopTaskInput(null); playSfx('success'); };
            const handleAddGoal = (title, target, linkedAccounts, deadline) => { playSfx('success'); setGoals([...goals, { id: Date.now(), title, target: parseFloat(target), linkedAccounts: linkedAccounts || [], deadline: deadline || null }]); };
            const handleUpdateGoal = (id, title, target, linkedAccounts, deadline) => { playSfx('success'); setGoals(prev => prev.map(g => g.id === id ? { ...g, title, target: parseFloat(target), linkedAccounts: linkedAccounts || [], deadline: deadline || null } : g)); setEditGoal(null); };
            const handleDeleteGoal = (id) => { if(confirm('åˆªé™¤æ­¤ç›®æ¨™ï¼Ÿ')) { playSfx('delete'); setGoals(prev => prev.filter(g => g.id !== id)); } };
            const updateRate = (cur, val) => setRates(prev => ({...prev, [cur]: parseFloat(val)}));
            const deleteRate = (cur) => { if(cur==='USD') return; const newR = {...rates}; delete newR[cur]; setRates(newR); };
            const moveSection = (index, direction) => { playSfx('tap'); const newOrder = [...walletOrder]; if (direction === 'up' && index > 0) { [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]]; } else if (direction === 'down' && index < newOrder.length - 1) { [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]]; } setWalletOrder(newOrder); };
            const TabButton = ({ id, label, icon }) => ( <button onClick={() => { playSfx('tap'); setActiveTab(id); }} id={`nav-${id}`} className={`flex-1 flex flex-col items-center justify-center py-3 text-xs font-medium transition-colors ${activeTab === id ? 'text-blue-400' : 'text-slate-500 hover:text-slate-300'}`}><Icon name={icon} className="w-5 h-5 mb-1" />{label}</button> );
            
            // ... [renderSection code is same] ...
            const renderSection = (type, index) => {
                if (type === 'cashTW') {
                    return (
                        <div key="cashTW" className="glass-panel rounded-xl overflow-hidden border border-slate-700">
                            <div className="bg-slate-800/80 p-3 border-b border-slate-700 flex justify-between items-center"><span className="text-sm font-bold text-emerald-400 flex items-center"><Icon name="wallet" className="w-4 h-4 mr-2" /> å°å¹£ç¾é‡‘</span><div className="flex items-center gap-2"><span className="text-xs font-mono text-slate-300 mr-1">{displayMoney(totalCashTWD)}</span><div id="wallet-reorder-btns-cashTW" className="flex"><button onClick={() => moveSection(index, 'up')} className="p-1 hover:text-white text-slate-500"><Icon name="arrow-up" className="w-3 h-3" /></button><button onClick={() => moveSection(index, 'down')} className="p-1 hover:text-white text-slate-500"><Icon name="arrow-down" className="w-3 h-3" /></button></div><button id="wallet-add-cash" onClick={() => { playSfx('pop'); setAddItemType('cash'); }} className="p-1 bg-slate-700 rounded hover:bg-slate-600 ml-1"><Icon name="plus" className="w-3 h-3" /></button></div></div>
                            {cash.map(item => (<div key={item.id} onClick={() => openEditItem({ type: 'cash', data: item })} className="p-4 border-b border-slate-800/50 flex justify-between items-center active:bg-slate-700/50 cursor-pointer"><div><div className="text-sm text-slate-200">{item.name}</div><div className="text-[10px] text-slate-500">{item.note || (item.locked ? 'ğŸ”’ å°å­˜' : 'ğŸŸ¢ æ´»å­˜')}</div></div><div className="text-sm font-mono text-emerald-400">{displayMoney(item.balance)}</div></div>))}
                        </div>
                    );
                }
                if (type === 'cashForeign') {
                    return (
                        <div key="cashForeign" className="glass-panel rounded-xl overflow-hidden border border-slate-700">
                            <div className="bg-slate-800/80 p-3 border-b border-slate-700 flex justify-between items-center"><span className="text-sm font-bold text-purple-400 flex items-center"><Icon name="coins" className="w-4 h-4 mr-2" /> å¤–å¹£ç¾é‡‘</span><div className="flex items-center gap-2"><span className="text-xs font-mono text-slate-300 mr-1">{displayMoney(totalForeignCashTWD)}</span><div className="flex"><button onClick={() => moveSection(index, 'up')} className="p-1 hover:text-white text-slate-500"><Icon name="arrow-up" className="w-3 h-3" /></button><button onClick={() => moveSection(index, 'down')} className="p-1 hover:text-white text-slate-500"><Icon name="arrow-down" className="w-3 h-3" /></button></div><button onClick={() => { playSfx('pop'); setAddItemType('cashForeign'); }} className="p-1 bg-slate-700 rounded hover:bg-slate-600 ml-1" title="å¤–å¹£ç¾é‡‘"><Icon name="plus" className="w-3 h-3" /></button></div></div>
                            {foreignCash.map(item => (<div key={item.id} onClick={() => openEditItem({ type: 'cashForeign', data: item })} className="p-4 border-b border-slate-800/50 flex justify-between items-center active:bg-slate-700/50 cursor-pointer"><div className="flex items-center gap-2"><div className="bg-purple-900/50 text-purple-300 text-[10px] px-1.5 py-0.5 rounded border border-purple-500/30">{item.currency}</div><div><div className="text-sm text-slate-200">{item.name}</div>{item.note && <div className="text-[10px] text-slate-500">{item.note}</div>}</div></div><div className="text-right"><div className="text-sm font-mono text-purple-300">{displayMoney(item.balance * (rates[item.currency] || 1))}</div><div className="text-[10px] text-slate-500">{formatForeign(item.balance, item.currency)}</div></div></div>))}
                        </div>
                    );
                }
                if (type === 'stockForeign') {
                    return (
                        <div key="stockForeign" className="glass-panel rounded-xl overflow-hidden border border-slate-700">
                            <div className="bg-slate-800/80 p-3 border-b border-slate-700 flex justify-between items-center"><span className="text-sm font-bold text-pink-400 flex items-center"><Icon name="globe" className="w-4 h-4 mr-2" /> æµ·å¤–æŠ•è³‡</span><div className="flex items-center gap-2"><span className="text-xs font-mono text-slate-300 mr-1">{displayMoney(totalForeignStocksTWD)}</span><div className="flex"><button onClick={() => moveSection(index, 'up')} className="p-1 hover:text-white text-slate-500"><Icon name="arrow-up" className="w-3 h-3" /></button><button onClick={() => moveSection(index, 'down')} className="p-1 hover:text-white text-slate-500"><Icon name="arrow-down" className="w-3 h-3" /></button></div><button onClick={() => { playSfx('pop'); setAddItemType('stockForeign'); }} className="p-1 bg-slate-700 rounded hover:bg-slate-600 ml-1" title="å¤–åœ‹è‚¡ç¥¨"><Icon name="plus" className="w-3 h-3" /></button></div></div>
                            {foreignStocks.map(item => (<div key={item.id} onClick={() => openEditItem({ type: 'stockForeign', data: item })} className="p-4 border-b border-slate-800/50 flex justify-between items-center active:bg-slate-700/50 cursor-pointer"><div><div className="flex items-center gap-2 mb-0.5"><div className="bg-blue-900/50 text-blue-300 text-[10px] px-1.5 py-0.5 rounded border border-blue-500/30">{item.currency}</div><div className="text-sm text-slate-200 font-bold truncate max-w-[150px]">{item.name}</div></div><div className="text-[10px] text-slate-500 font-mono pl-10">{item.ticker} â€¢ {item.shares} è‚¡</div>{item.note && <div className="text-[10px] text-slate-500 pl-10">{item.note}</div>}</div><div className="text-right"><div className="text-sm font-mono text-purple-400">{displayMoney(item.price * item.shares * (rates[item.currency] || 1))}</div><div className="text-[10px] text-slate-400 font-mono">{formatForeign(item.price * item.shares, item.currency)}</div><div className="text-[10px] text-slate-500 font-mono">@ {formatForeign(item.price, item.currency)}</div></div></div>))}
                        </div>
                    );
                }
                if (type === 'stockTW') {
                    return (
                        <div key="stockTW" className="glass-panel rounded-xl overflow-hidden border border-slate-700">
                            <div className="bg-slate-800/80 p-3 border-b border-slate-700 flex justify-between items-center"><span className="text-sm font-bold text-sky-400 flex items-center"><Icon name="trending-up" className="w-4 h-4 mr-2" /> å°è‚¡ç¾è²¨</span><div className="flex items-center gap-2"><span className="text-xs font-mono text-slate-300 mr-1">{displayMoney(totalTwStocksTWD)}</span><div className="flex"><button onClick={() => moveSection(index, 'up')} className="p-1 hover:text-white text-slate-500"><Icon name="arrow-up" className="w-3 h-3" /></button><button onClick={() => moveSection(index, 'down')} className="p-1 hover:text-white text-slate-500"><Icon name="arrow-down" className="w-3 h-3" /></button></div><button onClick={() => { playSfx('pop'); setAddItemType('stockTW'); }} className="p-1 bg-slate-700 rounded hover:bg-slate-600 ml-1"><Icon name="plus" className="w-3 h-3" /></button></div></div>
                            {twStocks.map(item => (<div key={item.id} onClick={() => openEditItem({ type: 'stockTW', data: item })} className="p-4 border-b border-slate-800/50 flex justify-between items-center active:bg-slate-700/50 cursor-pointer"><div><div className="text-sm text-slate-200 font-bold truncate max-w-[150px]">{item.name}</div><div className="text-[10px] text-slate-500 font-mono">{item.ticker} â€¢ {item.shares} è‚¡</div>{item.note && <div className="text-[10px] text-slate-500">{item.note}</div>}</div><div className="text-right"><div className="text-sm font-mono text-sky-400">{displayMoney(item.price * item.shares)}</div><div className="text-[10px] text-slate-500 font-mono">@ {displayMoney(item.price)}</div></div></div>))}
                        </div>
                    );
                }
            };

            return (
                <div className="min-h-screen pb-24 safe-area-bottom safe-area-top bg-slate-900">
                    {/* Header */}
                    <header className="px-6 py-4 pb-2 sticky top-0 bg-slate-900/95 backdrop-blur-md z-10 border-b border-slate-800/50">
                        <div className="flex justify-between items-center mb-2">
                            <h1 className="text-slate-200 text-sm font-bold tracking-wide flex items-center font-sans">
                                <Icon name="shield-check" className="w-4 h-4 mr-2 text-emerald-500" />AssetPilot
                                <span className="ml-2 text-slate-500 normal-case font-normal tracking-normal border-l border-slate-700 pl-2 text-xs">ä½ å¥½ï¼Œ{userName}</span>
                            </h1>
                            <div className="flex items-center gap-3">
                                <button id="header-privacy" onClick={() => { playSfx('switch'); setIsPrivacyMode(!isPrivacyMode); }} className={`text-slate-400 hover:text-white transition-colors`}>
                                    <Icon name={isPrivacyMode ? "eye-off" : "eye"} className="w-4 h-4" />
                                </button>
                                <div className="text-[10px] text-slate-500 font-mono">{lastUpdate ? `${lastUpdate}` : 'Ready'}</div>
                                <button id="header-settings" onClick={() => { playSfx('pop'); setShowSettings(true); }} className="text-slate-400 hover:text-white"><Icon name="settings" className="w-4 h-4" /></button>
                            </div>
                        </div>
                        <div className="flex justify-between items-end">
                            <div className="text-4xl font-bold text-white tracking-tight font-mono text-gradient">
                                {displayMoney(totalNetWorth)}
                            </div>
                            <button id="header-refresh" onClick={fetchLiveData} disabled={isUpdating} className={`mb-2 p-2 rounded-full bg-slate-800 border border-slate-700 text-blue-400 active:scale-95 transition-all ${isUpdating ? 'opacity-50' : ''}`}><Icon name="refresh-cw" className={`w-5 h-5 ${isUpdating ? 'animate-spin' : ''}`} /></button>
                        </div>
                    </header>

                    {/* Rates Ticker */}
                    <div id="ticker-rates" className="px-6 pt-2 pb-0 flex overflow-x-auto no-scrollbar gap-2">
                        {Object.entries(rates).filter(([cur]) => activeCurrencies.includes(cur)).map(([cur, rate]) => (
                            <div key={cur} className="bg-slate-800/80 px-3 py-1 rounded-full border border-slate-700/50 flex items-center gap-2 whitespace-nowrap">
                                <span className="text-[10px] text-slate-400 uppercase tracking-wider">{cur}</span>
                                <span className="text-xs font-bold text-emerald-400 font-mono">{rate.toFixed(2)}</span>
                            </div>
                        ))}
                    </div>

                    {/* Dashboard */}
                    {activeTab === 'dashboard' && (
                        <div className="px-4 animate-fade-in pt-4 space-y-4">
                            <div id="chart-area" className="glass-panel rounded-2xl p-4 shadow-lg shadow-blue-900/10 border-t border-white/5">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xs text-slate-400 font-bold uppercase">è³‡ç”¢è¶¨å‹¢</h3>
                                    <div id="chart-controls" className="flex bg-slate-800 rounded-lg p-0.5">
                                        {['æ—¥', 'æœˆ', 'å¹´'].map(r => (
                                            <button key={r} onClick={() => { playSfx('tap'); setTimeRange(r); setCustomDates({start:'', end:''}); }} className={`px-4 py-0.5 text-[10px] rounded ${timeRange === r ? 'bg-slate-600 text-white' : 'text-slate-400'}`}>{r}</button>
                                        ))}
                                        <button onClick={() => { playSfx('pop'); setShowDateModal(true); }} className={`px-2 py-0.5 text-[10px] rounded flex items-center justify-center ${timeRange === 'CUSTOM' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:bg-slate-700'}`}>
                                            <Icon name="calendar" className="w-3 h-3" />
                                        </button>
                                    </div>
                                </div>
                                <div className="flex space-x-4 mb-4 overflow-x-auto pb-1 no-scrollbar">
                                    {[{id:'total',l:'ç¸½è³‡ç”¢'},{id:'cashTW',l:'å°å¹£è³‡é‡‘'},{id:'stockTW',l:'å°è‚¡éƒ¨ä½'},{id:'cashForeign',l:'å¤–å¹£è³‡é‡‘'},{id:'stockForeign',l:'æµ·å¤–æŠ•è³‡'}].map(m => (
                                        <button key={m.id} onClick={() => { playSfx('tap'); setTrendMode(m.id); }} className={`text-xs font-bold whitespace-nowrap pb-1 border-b-2 transition-colors ${trendMode === m.id ? 'border-blue-500 text-white' : 'border-transparent text-slate-500'}`}>{m.l}</button>
                                    ))}
                                </div>
                                <AssetTrendChart history={history} timeRange={timeRange} mode={trendMode} customDates={customDates} isPrivacyMode={isPrivacyMode} />
                            </div>
                            <div id="allocation-section" className="glass-panel rounded-xl p-4">
                                <h3 className="text-xs text-slate-400 font-bold uppercase mb-4">è³‡ç”¢é…ç½®</h3>
                                <AllocationBar cash={totalCashTWD} tw={totalTwStocksTWD} us={totalForeignAssetsTWD} total={totalNetWorth} isPrivacyMode={isPrivacyMode} playSfx={playSfx} />
                            </div>
                            <div id="sop-section" className="glass-panel rounded-xl p-4">
                                <div className="flex justify-between items-center mb-3">
                                    <div className="flex items-center gap-2"><h3 className="text-xs text-slate-400 uppercase tracking-wider font-bold">æ¯æœˆä»»å‹™</h3><button onClick={() => { playSfx('pop'); setShowSopModal(true); }} className="text-slate-500 hover:text-yellow-400"><Icon name="lightbulb" className="w-4 h-4" /></button></div>
                                    <button onClick={() => { playSfx('tap'); setSopEditMode(!sopEditMode); }} className="text-xs text-blue-400">{sopEditMode ? 'å®Œæˆ' : 'ç·¨è¼¯'}</button>
                                </div>
                                <div className="space-y-2">
                                    {sopList.length > 0 ? sopList.map(sop => (<div key={sop.id} className="flex items-center justify-between p-3 rounded-lg bg-slate-800/50 border border-slate-700/50"><div className="flex items-center text-sm text-slate-300 flex-1 cursor-pointer" onClick={() => !sopEditMode && toggleSop(sop.id)}><div className={`w-5 h-5 rounded border mr-3 flex items-center justify-center transition-colors ${sop.completed ? 'bg-emerald-500 border-emerald-500' : 'border-slate-500'}`}>{sop.completed && (<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>)}</div><span className={`${sop.completed ? 'line-through text-slate-600' : ''} ${sopEditMode ? 'underline decoration-dashed decoration-slate-600' : ''}`} onClick={(e) => { if (sopEditMode) { e.stopPropagation(); editSopText(sop.id, sop.text); }}}>{sop.text}</span></div>{sopEditMode && <button onClick={() => deleteSop(sop.id)} className="ml-2 text-red-500"><Icon name="trash-2" className="w-4 h-4" /></button>}</div>)) : <div className="text-xs text-slate-500 text-center py-2">ç„¡å¾…è¾¦äº‹é …</div>}
                                    {sopEditMode && <button onClick={addSop} className="w-full py-2 text-xs border border-dashed border-slate-600 text-slate-500 rounded hover:border-slate-400 hover:text-slate-400">+ æ–°å¢ä»»å‹™</button>}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 2: Wallet & Tab 3: Analysis (Render logic same as before, using renderSection) */}
                    {activeTab === 'wallet' && (
                        <div className="px-6 space-y-4 pb-20 animate-fade-in pt-4">
                            <p className="text-xs text-center text-slate-500 mb-2">é»æ“Šå¡ç‰‡é–‹å•Ÿè¨ˆç®—æ©Ÿ / ä¿®æ­£è‚¡æ•¸</p>
                            {walletOrder.map((type, index) => renderSection(type, index))}
                        </div>
                    )}

                    {/* Tab 3: Analysis (Updated for V22.0 Goals) */}
                    {activeTab === 'analysis' && (
                        <div className="px-4 animate-fade-in pt-4 space-y-6">
                            <div id="goal-section">
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className="text-xs text-slate-400 font-bold uppercase">è²¡å‹™ç›®æ¨™</h3>
                                    <button id="goal-add-btn" onClick={() => { playSfx('pop'); setEditGoal({ id: null }); }} className="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg flex items-center"><Icon name="plus" className="w-3 h-3 mr-1" /> æ–°å¢å°ˆæ¡ˆ</button>
                                </div>
                                <div className="space-y-3">
                                    {goals.map(g => (
                                        <CircularGoal 
                                            key={g.id} 
                                            goal={g}
                                            current={totalNetWorth} // Fallback for legacy data or if needed
                                            target={g.target} 
                                            onEdit={() => { playSfx('pop'); setEditGoal(g); }} 
                                            onDelete={() => handleDeleteGoal(g.id)} 
                                            isPrivacyMode={isPrivacyMode}
                                            rates={rates}
                                            cash={cash}
                                            twStocks={twStocks}
                                            foreignStocks={foreignStocks}
                                            foreignCash={foreignCash}
                                        />
                                    ))}
                                    {goals.length === 0 && <div className="text-slate-500 text-xs text-center py-4">å°šæœªè¨­å®šç›®æ¨™ï¼Œé–‹å§‹è¦åŠƒæ‚¨çš„å¤¢æƒ³å§ï¼</div>}
                                </div>
                            </div>
                            
                            {/* Monthly Report */}
                            <div>
                                <h3 className="text-xs text-slate-400 font-bold uppercase mb-3">æœˆåº¦æˆ°å ±</h3>
                                <div className="glass-panel rounded-xl p-5 mb-4 border-l-4 border-purple-500">
                                    <h3 className="text-slate-400 text-xs uppercase mb-1">å¹´åº¦æˆ°æ³ç¸½çµ (2026)</h3>
                                    <div className="text-2xl font-bold text-white mb-2">{ytdStats.diff > 0 ? '+' : ''}{isPrivacyMode ? '****' : formatMoney(ytdStats.diff)}<span className={`text-sm font-normal ml-2 ${ytdStats.diff >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{ytdStats.diff > 0 ? '+' : ''}{ytdStats.percent.toFixed(2)}%</span></div>
                                    <div className="text-xs text-slate-500">ç´¯ç©ç›ˆè™§ (YTD)</div>
                                </div>
                                <div className="space-y-3">
                                    {monthlyReportData.map((report, idx) => { 
                                        const prevMonth = monthlyReportData[idx + 1]; 
                                        const diff = prevMonth ? report.total - prevMonth.total : 0; 
                                        const diffPercent = prevMonth && prevMonth.total !== 0 ? (diff / prevMonth.total * 100).toFixed(2) : 0; 
                                        return (
                                            <div key={report.date} className="glass-panel rounded-xl p-4 flex justify-between items-center">
                                                <div><div className="text-sm text-slate-300 font-bold">{report.date.substring(0, 7)}</div><div className="text-xs text-slate-500">çµç®—æ—¥: {report.date}</div></div>
                                                <div className="text-right"><div className="text-sm font-mono text-white">{displayMoney(report.total)}</div><div className={`text-xs ${diff >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{diff >= 0 ? '+' : ''}{displayMoney(diff)} ({diff >= 0 ? '+' : ''}{diffPercent}%)</div></div>
                                            </div>
                                        ); 
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Navigation */}
                    <nav id="main-nav" className="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-xl border-t border-slate-800 flex justify-around pb-safe-area-bottom z-50 h-20 items-start pt-3">
                        <TabButton id="dashboard" label="æˆ°æƒ…å®¤" icon="layout-dashboard" />
                        <TabButton id="wallet" label="é‡‘åº«" icon="wallet" />
                        <TabButton id="analysis" label="åˆ†æ" icon="pie-chart" />
                    </nav>

                    {/* Toast */}
                    <Toast message={toast.message} show={toast.show} />

                    {/* Welcome Modal */}
                    {showWelcome && <WelcomeModal onConfirm={handleWelcomeConfirm} />}

                    {/* Tutorial Modal */}
                    {showTutorial && (
                        <TutorialSpotlight 
                            stepIndex={tutorialStep} 
                            totalSteps={TUTORIAL_STEPS.length} 
                            onNext={handleTutorialNext} 
                            onPrev={handleTutorialPrev}
                            onClose={handleTutorialClose} 
                        />
                    )}

                    {/* SOP Input Modal (Dashboard) */}
                    {sopTaskInput && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center z-[100] sm:p-6 animate-fade-in" onClick={() => setSopTaskInput(null)}>
                            <div className="bg-slate-800 border-t sm:border border-slate-700 rounded-t-2xl sm:rounded-2xl p-6 w-full max-w-sm shadow-2xl safe-area-bottom" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-lg font-bold text-white flex items-center">
                                        {sopTaskInput.id ? 'ç·¨è¼¯ä»»å‹™' : 'æ–°å¢ä»»å‹™'}
                                    </h3>
                                    <button onClick={() => setSopTaskInput(null)} className="text-slate-400 hover:text-white"><Icon name="x" className="w-6 h-6" /></button>
                                </div>
                                <div className="space-y-4 mb-6">
                                    <input 
                                        id="sopTaskInput"
                                        type="text" 
                                        defaultValue={sopTaskInput.text}
                                        autoFocus
                                        className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none text-base"
                                        placeholder="è¼¸å…¥ä»»å‹™å…§å®¹..."
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                                handleSaveSopTask(e.target.value);
                                            }
                                        }}
                                    />
                                </div>
                                <button 
                                    onClick={() => handleSaveSopTask(document.getElementById('sopTaskInput').value)} 
                                    className="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg"
                                >
                                    ç¢ºèª
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Goal Input Modal (V22.0) */}
                    {editGoal && (
                        <GoalInputModal 
                            title={editGoal.id ? 'ç·¨è¼¯ç›®æ¨™' : 'æ–°å¢ç›®æ¨™'}
                            target={editGoal.target}
                            deadline={editGoal.deadline}
                            linkedAccounts={editGoal.linkedAccounts}
                            cash={cash}
                            twStocks={twStocks}
                            foreignStocks={foreignStocks}
                            foreignCash={foreignCash}
                            onConfirm={(t, v, l, d) => { 
                                if (editGoal.id) handleUpdateGoal(editGoal.id, t, v, l, d); 
                                else { handleAddGoal(t, v, l, d); setEditGoal(null); } 
                            }}
                            onClose={() => { playSfx('pop'); setEditGoal(null); }}
                            playSfx={playSfx}
                        />
                    )}

                    {/* Modals */}
                    {updateResults && <UpdateResultModal results={updateResults} onClose={() => setUpdateResults(null)} isPrivacyMode={isPrivacyMode} />}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100] p-6 animate-fade-in" onClick={() => { playSfx('pop'); setShowSettings(false); }}>
                            <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6 w-full max-w-sm shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-lg font-bold text-white flex items-center"><Icon name="settings" className="w-5 h-5 mr-2" /> è¨­å®š</h3>
                                    <button onClick={() => { playSfx('pop'); setShowSettings(false); }} className="text-slate-400"><Icon name="x" className="w-5 h-5" /></button>
                                </div>
                                <div className="space-y-4 overflow-y-auto max-h-[60vh] pr-2 custom-scrollbar">
                                    {/* User Name */}
                                    <div className="mt-4 mb-2">
                                        <label className="block text-xs text-slate-400 mb-2">ä½¿ç”¨è€…åç¨±</label>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                value={userName} 
                                                onChange={(e) => setUserName(e.target.value)} 
                                                className="bg-slate-900 border border-slate-600 rounded-lg p-3 w-full text-white focus:border-blue-500 outline-none placeholder-slate-600"
                                                placeholder="è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±"
                                            />
                                            <button 
                                                onClick={() => {
                                                    playSfx('success');
                                                    triggerToast('ä½¿ç”¨è€…åç¨±å·²æ›´æ–°');
                                                    setShowSettings(false);
                                                }} 
                                                className="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded-lg font-bold text-sm whitespace-nowrap transition-colors"
                                            >
                                                å„²å­˜
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Sound Toggle - Redesigned Card */}
                                    <div className="mt-4 mb-2">
                                        <label className="block text-xs text-slate-400 mb-2">ç³»çµ±è¨­å®š</label>
                                        <div 
                                            onClick={() => { 
                                                const newState = !soundEnabled;
                                                setSoundEnabled(newState); 
                                                if (newState) {
                                                    SoundEngine.init(); 
                                                    SoundEngine.play('switch');
                                                }
                                            }}
                                            className={`flex items-center justify-between p-3 rounded-xl border transition-all cursor-pointer ${soundEnabled ? 'bg-blue-500/10 border-blue-500/50' : 'bg-slate-800 border-slate-600 hover:border-slate-500'}`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-colors ${soundEnabled ? 'bg-blue-500 text-white' : 'bg-slate-700 text-slate-400'}`}>
                                                    <Icon name={soundEnabled ? "volume-2" : "volume-x"} className="w-4 h-4" />
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className={`text-xs font-bold ${soundEnabled ? 'text-blue-100' : 'text-slate-300'}`}>éŸ³æ•ˆå›é¥‹</span>
                                                    <span className="text-[10px] text-slate-500">{soundEnabled ? 'ç³»çµ±éŸ³æ•ˆå·²é–‹å•Ÿ' : 'éœéŸ³æ¨¡å¼'}</span>
                                                </div>
                                            </div>
                                            <div className={`w-10 h-5 rounded-full relative transition-colors duration-300 ${soundEnabled ? 'bg-blue-500' : 'bg-slate-600'}`}>
                                                <div className={`absolute top-1 w-3 h-3 rounded-full bg-white shadow-sm transition-transform duration-300 ${soundEnabled ? 'translate-x-6' : 'translate-x-1'}`}></div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Backup & Restore */}
                                    <div className="pt-2 border-t border-slate-700">
                                        <label className="block text-xs text-slate-400 mb-2">è³‡æ–™å‚™ä»½/é‚„åŸ</label>
                                        <div className="flex gap-2">
                                            <button onClick={exportData} className="flex-1 py-2 rounded bg-blue-600/20 text-blue-400 text-xs border border-blue-600/50">åŒ¯å‡º (Backup)</button>
                                            <label className="flex-1 py-2 rounded bg-emerald-600/20 text-emerald-400 text-xs border border-emerald-600/50 text-center cursor-pointer">
                                                åŒ¯å…¥ (Restore)
                                                <input type="file" className="hidden" onChange={importData} accept=".json" />
                                            </label>
                                        </div>
                                    </div>

                                    {/* Reset System Button */}
                                    <div className="pt-2 border-t border-slate-700 mt-2">
                                        <label className="block text-xs text-red-400 mb-2">å±éšªå€åŸŸ</label>
                                        <button 
                                            onClick={() => {
                                                if (confirm('è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡ç½®ç³»çµ±ï¼æ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                                                    localStorage.clear();
                                                    window.location.reload();
                                                }
                                            }} 
                                            className="w-full py-3 rounded bg-red-500/10 text-red-500 text-xs border border-red-500/50 hover:bg-red-500/20 transition-colors flex items-center justify-center gap-2"
                                        >
                                            <Icon name="alert-triangle" className="w-3 h-3" /> é‡ç½®ç³»çµ±è³‡æ–™
                                        </button>
                                    </div>

                                    {/* Replay Tutorial Button */}
                                    <div className="pt-2 border-t border-slate-700">
                                        <button onClick={replayTutorial} className="w-full py-2 text-xs text-slate-400 hover:text-white hover:bg-slate-700 rounded transition-colors flex items-center justify-center gap-2">
                                            <Icon name="help-circle" className="w-3 h-3" /> é‡æ’­æ–°æ‰‹æ•™å­¸å°è¦½
                                        </button>
                                    </div>
                                </div>
                                <div className="text-center mt-6 pt-4 border-t border-slate-700/50">
                                    <div className="text-[10px] text-slate-600 font-mono tracking-widest">v22.1</div>
                                    <div className="text-[10px] text-slate-600 mt-1">Designed by <span className="text-slate-500 font-bold hover:text-blue-400 transition-colors cursor-default">YAMANEMU Studio</span></div>
                                </div>
                            </div>
                        </div>
                    )}
                    {showSopModal && <SopDetailsModal sopDetails={sopDetails} setSopDetails={setSopDetails} onClose={() => { playSfx('pop'); setShowSopModal(false); }} playSfx={playSfx} />}
                    {showDateModal && (<DateRangeModal currentDates={customDates} onConfirm={(s, e) => { playSfx('success'); setCustomDates({ start: s, end: e }); setTimeRange('CUSTOM'); setShowDateModal(false); }} onClose={() => { playSfx('pop'); setShowDateModal(false); }} />)}
                    
                    {/* Add Item Modal */}
                    {addItemType && (<div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center z-[100] sm:p-6 animate-fade-in"><div className="bg-slate-800 border-t sm:border border-slate-700 rounded-t-2xl sm:rounded-2xl p-6 w-full max-w-sm shadow-2xl safe-area-bottom"><div className="flex justify-between items-center mb-6"><h3 className="text-lg font-bold text-white">æ–°å¢é …ç›®</h3><button onClick={() => { playSfx('pop'); setAddItemType(null); }} className="text-slate-400 hover:text-white"><Icon name="x" className="w-6 h-6" /></button></div>
                    <div className="space-y-4 mb-6">
                        {(addItemType === 'cashForeign' || addItemType === 'stockForeign') && (
                            <div><label className="text-xs text-slate-400 mb-1 block">å¹£åˆ¥</label>
                            <select id="addCur" className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                                {CURRENCY_OPTIONS.map(c => <option key={c.code} value={c.code}>{c.code} - {c.name}</option>)}
                            </select></div>
                        )}
                        <div><label className="text-xs text-slate-400 mb-1 block">{addItemType.includes('cash') ? 'å¸³æˆ¶åç¨±' : 'è‚¡ç¥¨ä»£è™Ÿ (ä¾‹: 7203.T)'}</label><input id="addMain" type="text" className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none" /></div>
                        {addItemType.includes('stock') && (<div><label className="text-xs text-slate-400 mb-1 block">è‚¡ç¥¨åç¨± (é¸å¡«)</label><input id="addSub" type="text" className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none" /></div>)}
                        <div><label className="text-xs text-slate-400 mb-1 block">{addItemType.includes('cash') ? 'åˆå§‹é‡‘é¡' : 'æŒæœ‰è‚¡æ•¸'}</label><input id="addVal" type="number" className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none" /></div>
                        <div><label className="text-xs text-slate-400 mb-1 block">å‚™è¨» (é¸å¡«)</label><input id="addNote" type="text" placeholder={addItemType === 'cash' ? "ä¾‹å¦‚: æ´»å­˜" : ""} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none" /></div>
                    </div>
                    <button onClick={() => {
                        playSfx('tap');
                        const name = document.getElementById('addMain').value; 
                        const val = document.getElementById('addVal').value; 
                        const sub = document.getElementById('addSub') ? document.getElementById('addSub').value : ''; 
                        const cur = document.getElementById('addCur') ? document.getElementById('addCur').value : null;
                        const note = document.getElementById('addNote').value;
                        if (name && val) {
                            if (addItemType.includes('cash')) { handleAddItem(addItemType, name, val, cur, null, note); } 
                            else { handleAddItem(addItemType, name, sub, val, cur, note); }
                        }
                    }} className="w-full py-4 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-lg">ç¢ºèªæ–°å¢</button></div></div>)}
                    
                    {/* Edit Item Modal */}
                    {editItem && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center z-[100] sm:p-6 animate-fade-in" onClick={() => { playSfx('pop'); setEditItem(null); }}>
                            <div className="bg-slate-800 border-t sm:border border-slate-700 rounded-t-2xl sm:rounded-2xl p-6 w-full max-w-sm shadow-2xl safe-area-bottom" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-white">{editItem.type.includes('cash') ? 'æ›´æ–°é¤˜é¡èˆ‡è³‡è¨Š' : 'æ›´æ–°è‚¡æ•¸èˆ‡è³‡è¨Š'}</h3>
                                    <button onClick={() => { playSfx('pop'); setEditItem(null); }} className="text-slate-400"><Icon name="x" className="w-6 h-6" /></button>
                                </div>
                                <div className="space-y-3 mb-4">
                                    <input type="text" id="editName" defaultValue={editItem.data.name} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white text-sm focus:border-blue-500 outline-none" placeholder="åç¨±"/>
                                    <input type="text" id="editNote" defaultValue={editItem.data.note} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white text-xs focus:border-blue-500 outline-none" placeholder="å‚™è¨» (ä¾‹: æ´»å­˜)"/>
                                </div>
                                {editItem.type.includes('cash') ? (
                                    <>
                                        <Calculator initialValue={editItem.data.balance} onConfirm={(val) => handleUpdateValue(editItem.data.id, editItem.type, val, document.getElementById('editName').value, document.getElementById('editNote').value)} playSfx={playSfx}/>
                                        <div className="mt-4 pt-4 border-t border-slate-700 flex justify-end">
                                            <button onClick={(e) => { e.stopPropagation(); playSfx('tap'); if (deleteConfirm) { performDelete(editItem.data.id, editItem.type); } else { setDeleteConfirm(true); } }} className={`py-2 px-4 rounded-lg flex items-center text-sm font-bold transition-all ${deleteConfirm ? 'bg-red-600 text-white w-full justify-center' : 'bg-red-500/10 text-red-500 hover:bg-red-500/20'}`}><Icon name="trash-2" className="w-4 h-4 mr-2" />{deleteConfirm ? 'ç¢ºå®šè¦åˆªé™¤æ­¤å¸³æˆ¶å—ï¼Ÿ' : 'åˆªé™¤å¸³æˆ¶'}</button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <input type="number" id="simpleInput" defaultValue={editItem.data.shares} className="w-full bg-slate-900 border border-slate-600 rounded-xl py-4 px-4 text-2xl text-white font-mono mb-4 focus:border-blue-500 outline-none" autoFocus />
                                        <div className="flex gap-3">
                                            <button onClick={(e) => { e.stopPropagation(); playSfx('tap'); if (deleteConfirm) { performDelete(editItem.data.id, editItem.type); } else { setDeleteConfirm(true); } }} className={`py-4 px-6 rounded-xl transition-all ${deleteConfirm ? 'bg-red-600 text-white' : 'bg-red-500/10 text-red-500'}`}>{deleteConfirm ? 'ç¢ºå®š?' : <Icon name="trash-2" className="w-5 h-5" />}</button>
                                            <button onClick={() => handleUpdateValue(editItem.data.id, editItem.type, document.getElementById('simpleInput').value, document.getElementById('editName').value, document.getElementById('editNote').value)} className="flex-1 py-4 rounded-xl bg-blue-600 text-white font-bold">æ›´æ–°</button>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
